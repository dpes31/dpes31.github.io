<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶€ë™ì‚° íˆ¬ì ì‹œë®¬ë ˆì´í„°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Styles: Inter Font, basic style initialization */
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f4f6f8; }
        /* Add shadow and rounding to input fields and buttons */
        .input-group, button { transition: all 0.2s; }
        .input-group:focus-within { box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); }
        /* Result box animation */
        #result { opacity: 0; transform: translateY(20px); transition: opacity 0.5s ease-out, transform 0.5s ease-out; }
        .result-visible { opacity: 1 !important; transform: translateY(0) !important; }
        /* Adjust button font size for mobile optimization */
        button { font-size: 1.125rem; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#3b82f6', /* Blue 500 */
                        'secondary': '#10b981', /* Emerald 500 (Success) */
                        'warning': '#f97316', /* Orange 600 (Lack) */
                        'bg-light': '#f4f6f8',
                        'card-bg': '#ffffff',
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 sm:p-6 max-w-xl mx-auto">
    <!-- Header & Description -->
    <header class="text-center mb-6">
        <h1 class="text-2xl font-extrabold text-gray-800">ë¶€ë™ì‚° íˆ¬ì ì‹œë®¬ë ˆì´í„°</h1>
        <p class="text-sm text-gray-500 mt-1">2025.10.15 ê·œì œ (ê¸ˆìœµìœ„ì›íšŒ FAQ ê¸°ì¤€)</p>
    </header>
    <form id="simulatorForm" class="bg-card-bg p-6 rounded-xl shadow-lg">
        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ê¸°ë³¸ ì •ë³´ ì…ë ¥</h2>
        <!-- Input Group: ì£¼íƒ ìœ í˜• -->
        <div class="mb-4">
            <label for="type" class="block text-sm font-semibold text-gray-700 mb-1">ì£¼íƒ ìœ í˜•</label>
            <select id="type" onchange="toggleMidLoan(); updateRules();" class="input-group w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                <option value="buy">ì¼ë°˜ ë§¤ë§¤</option>
                <option value="lottery">ì²­ì•½/ë¶„ì–‘</option>
            </select>
        </div>
        <!-- Input Group: ì£¼íƒ ê°€ê²© -->
        <div class="mb-4">
            <label for="price" class="block text-sm font-semibold text-gray-700 mb-1">ì£¼íƒ ê°€ê²© (ì–µ ì›)</label>
            <input type="number" id="price" placeholder="10" step="0.1" oninput="updateRules(); showCap();" class="input-group w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
        </div>
        <!-- Input Group: íˆ¬ì ì§€ì—­ -->
        <div class="mb-4">
            <label for="region" class="block text-sm font-semibold text-gray-700 mb-1">íˆ¬ì ì§€ì—­</label>
            <select id="region" onchange="updateRules();" class="input-group w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                <option value="regulated">ê·œì œì§€ì—­ (ì„œìš¸/ìˆ˜ë„ê¶Œ ë“±)</option>
                <option value="non">ë¹„ê·œì œì§€ì—­</option>
            </select>
        </div>
        <!-- Input Group: ë³´ìœ  ì£¼íƒ ìˆ˜ -->
        <div class="mb-4">
            <label for="houses" class="block text-sm font-semibold text-gray-700 mb-1">ë³´ìœ  ì£¼íƒ ìˆ˜</label>
            <select id="houses" onchange="updateRules();" class="input-group w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                <option value="0">ë¬´ì£¼íƒ</option>
                <option value="1">1ì£¼íƒ</option>
                <option value="multi">ë‹¤ì£¼íƒ</option>
            </select>
        </div>
        <!-- LTV/Cap Display -->
        <div class="bg-blue-50 border-l-4 border-primary p-3 rounded-md mb-4 text-center">
            <div class="text-sm font-semibold text-blue-700" id="ltv-display">LTV: ê³„ì‚° ì¤‘...</div>
            <div class="text-sm font-semibold text-red-600 hidden mt-1" id="cap-display">ê³ ê°€í•œë„: ì ìš© ì¤‘...</div>
        </div>
        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 mt-6">ìê¸ˆ/ì†Œë“ ì •ë³´</h2>
        
        <!-- Input Group: ë³´ìœ  ìì‚° ì²˜ë¶„ ì˜ˆì • ê¸ˆì•¡ (ì´ê²ƒë§Œ ë‚¨ê¹€) -->
        <div class="mb-4">
            <label for="disposalAssets" class="block text-sm font-semibold text-gray-700 mb-1">ë³´ìœ  ìì‚° (ì²˜ë¶„ ì˜ˆì • ê¸ˆì•¡) (ì–µ ì›)</label>
            <input type="number" id="disposalAssets" placeholder="2" step="0.1" class="input-group w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
        </div>
        
        <!-- Input Group: ì—°ê°„ ì†Œë“ -->
        <div class="mb-4">
            <label for="income" class="block text-sm font-semibold text-gray-700 mb-1">ì—°ê°„ ì†Œë“ (ì„¸ì „, ì–µ ì›)</label>
            <input type="number" id="income" placeholder="1" step="0.1" class="input-group w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
        </div>
        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 mt-6">ëŒ€ì¶œ ì¡°ê±´</h2>
        
        <!-- Input Group: ì²­ì•½/ë¶„ì–‘ ì˜µì…˜ (ìˆ¨ê¹€/í‘œì‹œ í† ê¸€) -->
        <div class="mid-loan mb-4 hidden">
            <label class="block text-sm font-semibold text-gray-700 mb-2">ì²­ì•½ ë‚©ë¶€ ì¡°ê±´ (%)</label>
            <div class="grid grid-cols-3 gap-3">
                <div>
                    <label for="contractRate" class="block text-xs font-medium text-gray-600 mb-1">ê³„ì•½ê¸ˆ ë¹„ìœ¨(%)</label>
                    <!-- *** UPDATED: Added oninput event *** -->
                    <input type="number" id="contractRate" placeholder="10" value="10" step="1" min="0" max="40" oninput="updateBalanceRate()" class="input-group w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                </div>
                <div>
                    <label for="midLoanRate" class="block text-xs font-medium text-gray-600 mb-1">ì¤‘ë„ê¸ˆ ëŒ€ì¶œ(%)</label>
                    <input type="number" id="midLoanRate" placeholder="40" value="40" step="5" min="0" max="60" class="input-group w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                </div>
                <div>
                    <label for="balanceRate" class="block text-xs font-medium text-gray-600 mb-1">ì”ê¸ˆ ë¹„ìœ¨(%)</label>
                    <!-- *** UPDATED: Added readonly and bg-gray-100 *** -->
                    <input type="number" id="balanceRate" placeholder="30" value="30" step="1" min="0" readonly class="input-group w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary bg-gray-100 cursor-not-allowed">
                </div>
            </div>
            <!-- *** UPDATED: Helper text changed *** -->
            <p class="text-xs text-gray-500 mt-2">â€» ê³„ì•½ê¸ˆ+ì”ê¸ˆ=40% (ì¤‘ë„ê¸ˆ 60%) ê³ ì •ì…ë‹ˆë‹¤. ì”ê¸ˆì€ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.</p>
            <p class="text-xs text-gray-500 mt-1">â€» ì¤‘ë„ê¸ˆ ëŒ€ì¶œ(%)ì€ ì´ ë¶„ì–‘ê°€ ëŒ€ë¹„ ë¹„ìœ¨ì…ë‹ˆë‹¤. (ìµœëŒ€ 60%)</p>
        </div>
        
        <!-- Input Group: ëŒ€ì¶œ ê¸ˆë¦¬ (ê³µí†µ) -->
        <div class="mb-6">
            <label for="interestRate" class="block text-sm font-semibold text-gray-700 mb-1">ëŒ€ì¶œ ê¸ˆë¦¬ (%)</label>
            <input type="number" id="interestRate" placeholder="4.0" step="0.1" class="input-group w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
        </div>

        <!-- NEW: Error message display area for missing input values -->
        <div id="input-error-message" class="text-red-600 font-semibold p-2 bg-red-100 rounded-lg mb-4 hidden"></div>
        <button type="button" onclick="calculate()" class="w-full bg-primary hover:bg-blue-600 text-white font-bold py-3 rounded-xl shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-blue-300">
            ê²°ê³¼ ë¶„ì„í•˜ê¸°
        </button>
    </form>
    <!-- Result Section (Reordered) -->
    <div id="result" class="mt-8 bg-card-bg p-6 rounded-xl shadow-lg">
        <h2 class="text-2xl font-extrabold text-gray-800 text-center mb-6">íˆ¬ì ë¶„ì„ ê²°ê³¼</h2>
        <!-- Section 1: Loan Limit -->
        <div class="section bg-gray-50 p-4 rounded-xl shadow-sm mb-6" id="section-loan-limit">
            <h3 class="text-xl font-bold text-gray-700 mb-4 border-b border-gray-200 pb-2">1. ìµœëŒ€ ëŒ€ì¶œê¸ˆ</h3>
            <div id="final-loan-detail" class="text-center"></div>
            <div id="loan-breakdown" class="mt-4 border-t pt-3"></div>
        </div>
        
        <!-- Section 2: Cash Required (General Purchase Only) - REPURPOSED -->
        <div class="section bg-gray-50 p-4 rounded-xl shadow-sm mb-6" id="section-outlay">
            <h3 id="outlay-title" class="text-xl font-bold text-gray-700 mb-4 border-b border-gray-200 pb-2">2. ë§¤ë§¤ í˜„ê¸ˆ íë¦„ ìƒì„¸ ë¶„ì„</h3>
            <div id="outlay-items" class="space-y-2"></div>
            <p class="text-xs text-gray-500 mt-4 hidden" id="outlay-note">ì·¨ë“ì„¸ 3.3% + ì¤‘ê°œ ë³´ìˆ˜ë£Œ 0.6% + ê¸°íƒ€ 0.1ì–µ ì ìš©</p>
        </div>
        
        <!-- Section 2: Cash Flow (Subscription Only) -->
        <div class="section bg-gray-50 p-4 rounded-xl shadow-sm mb-6 hidden" id="loan-flow-section">
            <h3 class="text-xl font-bold text-gray-700 mb-4 border-b border-gray-200 pb-2">2. ì²­ì•½ í˜„ê¸ˆ íë¦„ ìƒì„¸ ë¶„ì„</h3>
            <div id="loan-flow-content"></div>
        </div>
        
        <!-- Section 3: Interest Section (NEW POSITION) -->
        <div class="section bg-card-bg p-4 rounded-xl shadow-md border border-gray-200 mb-6" id="interest-section-container">
            <!-- ID added: for dynamic title change -->
            <h3 id="section-3-title" class="text-xl font-bold text-gray-800 mb-4 border-b border-gray-200 pb-2">3. ì”ê¸ˆ ëŒ€ì¶œ ì›” ìƒí™˜ ì‹œë®¬ë ˆì´ì…˜</h3>
            <div id="interest-section" class="bg-card-bg">
                <h3 class="text-xl font-bold text-gray-800 text-center mb-4"><span id="total-loan-display"></span>ì–µ ëŒ€ì¶œ ì›” ìƒí™˜ (30ë…„)</h3>
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="repay-card flex-1 p-4 rounded-xl bg-blue-50 border-2 border-primary text-center">
                        <h4 class="text-base font-semibold text-primary">ì›ê¸ˆ ê· ë“± (ì¶”ì²œ)</h4>
                        <div class="monthly text-2xl font-extrabold text-primary mt-1" id="monthly-equal-principal"></div>
                        <small class="block text-gray-500 text-sm mt-1">
                            ì´ì´ì ë¶€ë‹´ ìµœì†Œ <span id="total-equal-principal-repay" class="font-extrabold text-primary"></span>
                        </small>
                    </div>
                    <div class="repay-card flex-1 p-4 rounded-xl bg-white border border-gray-300 text-center">
                        <h4 class="text-base font-semibold text-gray-600">ì›ë¦¬ê¸ˆ ê· ë“±</h4>
                        <div class="monthly text-2xl font-extrabold text-gray-700 mt-1" id="monthly-level-payment"></div>
                        <small class="block text-gray-500 text-sm mt-1">
                            ë§¤ì›” ìƒí™˜ì•¡ ë™ì¼ <span id="total-level-repay" class="font-extrabold text-gray-700"></span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Section 4: Total Summary (NOW HIDDEN FOR BOTH) -->
        <div class="section p-4 rounded-xl border-4 hidden" id="section-summary">
            <h3 class="text-xl font-bold text-gray-800 mb-4">4. ìµœì¢… ìê¸ˆ ì¡°ë‹¬ ìš”ì•½</h3>
            <div id="total-summary" class="space-y-3"></div>
            <div id="feasibility" class="mt-5 p-4 rounded-lg text-center font-extrabold text-xl shadow-inner"></div>
            <!-- Location for mid-loan repayment warning message -->
            <div id="final-warning-box"></div>
        </div>
        
        <!-- Policy Note -->
        <div class="tip-box mt-6 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded-r-md text-sm text-gray-700 leading-relaxed">
            <strong class="text-yellow-700">ì •ì±… ì°¸ê³  ì‚¬í•­</strong>
            <a href="https://www.fsc.go.kr/po020201/85518?srchCtgry=&curPage=&srchKey=&srchText=&srchBeginDt=&srchEndDt=" target="_blank" class="inline-block mt-2 px-3 py-1 bg-yellow-600 text-white font-semibold text-xs rounded-lg hover:bg-yellow-700">[ì£¼ìš” ì •ì±… ë³´ê¸°]</a>
        </div>
    </div>
    <script>
        // Global constants and initialization (keeping existing logic)
        const reg = {
            dsrRate: 0.4,
            stressRateReg: 0.03,
            stressRateNon: 0,
            costs: {
                taxRate: 0.033, // Acquisition tax (ì·¨ë“ì„¸)
                brokerageRate: 0.006, // Brokerage fee (ì¤‘ê°œ ë³´ìˆ˜ë£Œ) (Not used for subscription)
                etc: 0.1 // Other costs (ì–µ ì›) (Not used for subscription)
            },
            defaultRate: 4.0,
            term: 30
        };
        let currentLTV = 0;
        let currentLTVRate = '';
        let priceCap = 999;
        let isRegulatedCap = false;
        
        // Helper function: Amount formatting (ì–µ ì›)
        function formatAmount(amount, decimals = 2) {
            // Round to the second decimal place
            const rounded = parseFloat(amount).toFixed(decimals);
            return rounded + 'ì–µ';
        }
        // Helper function: Monthly payment formatting (ë§Œ ì›)
        function formatMonthly(amount) {
            return Math.round(amount / 10000).toLocaleString() + 'ë§Œì›';
        }
        
        // Helper function: Total repayment formatting (ì–µ ì›)
        function formatTotalRepay(amount) {
            const amountInOks = amount / 100000000;
            // Display two decimal places
            return `(ì´ ${parseFloat(amountInOks).toFixed(2)}ì–µ)`;
        }
        // Toggle mid-loan section visibility
        function toggleMidLoan() {
            const isLottery = document.getElementById('type').value === 'lottery';
            document.querySelector('.mid-loan').classList.toggle('hidden', !isLottery);
            updateRules();
        }
        // Display price cap information
        function showCap() {
            const price = parseFloat(document.getElementById('price').value) || 0;
            const region = document.getElementById('region').value;
            const capDisplay = document.getElementById('cap-display');
            
            // Multi-homeowner check is already handled in updateRules
            const houses = document.getElementById('houses').value;
            if (houses === 'multi') {
                capDisplay.classList.add('hidden');
                return;
            }
            
            if (region === 'regulated') {
                // Apply high-priced house standard for regulated areas (if price > 9ì–µ)
                let cap = price > 25 ? 2 : (price > 15 ? 4 : (price > 9 ? 6 : 999)); 
                if (price > 9) {
                     capDisplay.innerHTML = `ê³ ê°€í•œë„ ì ìš©: ìµœëŒ€ ${cap}ì–µ`;
                     capDisplay.classList.remove('hidden');
                } else {
                    // <= 9ì–µ
                    capDisplay.classList.add('hidden');
                }
            } else {
                // Non-regulated area
                capDisplay.classList.add('hidden');
            }
        }
        // Update LTV/DTI/DSR regulations logic
        function updateRules() {
            const region = document.getElementById('region').value;
            const houses = document.getElementById('houses').value;
            const price = parseFloat(document.getElementById('price').value) || 0;
            const type = document.getElementById('type').value;
            
            // 0. Multi-homeowner check (loan impossible)
            if (houses === 'multi') {
                currentLTV = 0;
                currentLTVRate = 'ë‹¤ì£¼íƒ 0%';
                document.getElementById('ltv-display').innerHTML = '<span class="text-red-600 font-extrabold">ë‹¤ì£¼íƒ: LTV 0% (ëŒ€ì¶œ ë¶ˆê°€)</span>';
                document.getElementById('cap-display').classList.add('hidden');
                return;
            }
            
            // 1. Base LTV setting
            let base = region === 'regulated' ? 0.4 : 0.7;
            let rateStr = region === 'regulated' ? '40%' : '70%';
            
            currentLTV = base;
            currentLTVRate = rateStr;
            const ltvAmt = price * currentLTV;
            document.getElementById('ltv-display').innerHTML = `LTV ${rateStr} â†’ ìµœëŒ€ <span class="text-primary">${ltvAmt.toFixed(1)}ì–µ</span>`;
            
            // 2. High-price cap setting (Applied in regulated areas & if price > 9ì–µ)
            isRegulatedCap = (region === 'regulated' && price > 9); 
            if (isRegulatedCap) {
                // <= 15ì–µ: 6ì–µ, > 15ì–µ & <= 25ì–µ: 4ì–µ, > 25ì–µ: 2ì–µ
                priceCap = price > 25 ? 2 : (price > 15 ? 4 : 6);
                showCap();
            } else {
                priceCap = 999; // No limit
                document.getElementById('cap-display').classList.add('hidden');
            }
            
            // 3. Section visibility management and title update
            const isLottery = type === 'lottery';
            document.getElementById('section-outlay').classList.toggle('hidden', isLottery);
            document.getElementById('loan-flow-section').classList.toggle('hidden', !isLottery);
            
            // *** UPDATED *** Always hide Section 4 (Summary)
            document.getElementById('section-summary').classList.add('hidden');
            
            // Update Section 2. Title based on type
            if (isLottery) {
                document.getElementById('loan-flow-section').querySelector('h3').textContent = '2. ì²­ì•½ í˜„ê¸ˆ íë¦„ ìƒì„¸ ë¶„ì„';
            } else {
                // *** UPDATED *** New title for 'buy' type
                document.getElementById('outlay-title').textContent = '2. ë§¤ë§¤ í˜„ê¸ˆ íë¦„ ìƒì„¸ ë¶„ì„';
            }
        }
        
        // Calculate DSR based maximum loan principal (Level Payment basis)
        function calculateDSRMaxPrincipal(annualIncome, annualRate, stress) {
            if (annualIncome <= 0) return 0;
            
            const stressAdj = (annualRate / 100) + stress; // Annual interest rate with Stress DSR
            const monthlyIncome = annualIncome * 100000000 / 12; // Monthly income (Won)
            const monthlyRate = stressAdj / 12; // Monthly interest rate
            const months = reg.term * 12; // Total repayment period (Months)
            const dsrMonthly = monthlyIncome * reg.dsrRate; // Monthly DSR limit
            
            if (monthlyRate <= 0) {
                 // If interest rate is 0 or negative (only consider P/n)
                return (dsrMonthly * months) / 100000000; 
            }
            
            const pow = Math.pow(1 + monthlyRate, months);
            // Formula for maximum loan principal based on level payment method
            // P = M * (1 - (1 + r)^-n) / r  -> M(Monthly payment) = dsrMonthly
            const maxP = dsrMonthly * (pow - 1) / (monthlyRate * pow);
            
            return maxP / 100000000; // ì–µ ì›
        }
        // Helper function: Calculate Level Payment monthly installment
        function calculateLevelPayment(principal, annualRate, months) {
            if (principal <= 0) return 0;
            const monthlyRate = (annualRate / 100) / 12;
            if (monthlyRate === 0) return principal / months; // If interest rate is 0%
            
            const pow = Math.pow(1 + monthlyRate, months);
            const monthlyPayment = principal * monthlyRate * pow / (pow - 1);
            return monthlyPayment; // Won (Monthly installment)
        }
        // Helper function: Calculate Equal Principal monthly installment (for a specific month)
        function calculateEqualPrincipal(principal, annualRate, currentMonth) {
            if (principal <= 0) return 0;
            const months = reg.term * 12;
            const monthlyRate = (annualRate / 100) / 12;
            // Monthly principal payment
            const principalPayment = principal / months; 
            // Interest for the current month (Remaining principal * Monthly interest rate)
            const interestPayment = (principal - (principalPayment * (currentMonth - 1))) * monthlyRate;
            return principalPayment + interestPayment; // Won (Installment for the month)
        }
        
        // *** NEW FUNCTION ***
        // Update balance rate based on contract rate (assuming 40% total)
        function updateBalanceRate() {
            const contractRateInput = document.getElementById('contractRate');
            const balanceRateInput = document.getElementById('balanceRate');
            
            let contractValue = parseFloat(contractRateInput.value) || 0;
            
            // Enforce 0 <= contractValue <= 40
            if (contractValue < 0) {
                contractValue = 0;
                contractRateInput.value = 0;
            }
            if (contractValue > 40) {
                contractValue = 40;
                contractRateInput.value = 40;
            }
            
            let balanceValue = 40 - contractValue;
            
            balanceRateInput.value = balanceValue.toFixed(0);
        }

        // Main calculation function
        function calculate() {
            const type = document.getElementById('type').value;
            const price = parseFloat(document.getElementById('price').value) || 0;
            const disposalAssets = parseFloat(document.getElementById('disposalAssets').value) || 0;
            const income = parseFloat(document.getElementById('income').value) || 0;
            const rate = parseFloat(document.getElementById('interestRate').value) || reg.defaultRate;
            const region = document.getElementById('region').value;
            const houses = document.getElementById('houses').value;
            
            // *** UPDATED: Get new input values for lottery type ***
            const contractRateInput = parseFloat(document.getElementById('contractRate').value) || 10;
            // *** UPDATED: Balance rate is now derived, not read ***
            const balanceRateInput = Math.max(0, 40 - contractRateInput); 
            // Update the readonly field just in case (e.g., if default was used)
            if (type === 'lottery') {
                document.getElementById('balanceRate').value = balanceRateInput.toFixed(0);
            }

            // midRate: ì¤‘ë„ê¸ˆ ëŒ€ì¶œ ë¹„ìœ¨ (ì´ ë¶„ì–‘ê°€ ëŒ€ë¹„)
            const midRate = type === 'lottery' ? parseFloat(document.getElementById('midLoanRate').value) || 40 : 0; 

            
            const errorMessageDiv = document.getElementById('input-error-message');
            errorMessageDiv.classList.add('hidden'); // Hide previous error message
            // *** UPDATED: Clear specific warning box for 'buy' type if it exists ***
            if (type === 'buy') {
                 const buyWarningBox = document.getElementById('final-warning-box-buy');
                 if(buyWarningBox) buyWarningBox.innerHTML = '';
            }
            document.getElementById('result').classList.remove('result-visible'); // Hide result area
            
            // *** Validation Check (Missing Input Check) ***
            if (price <= 0 || income <= 0) {
                 errorMessageDiv.innerHTML = ' ğŸš¨  í•„ìˆ˜ ì…ë ¥ê°’: ì£¼íƒ ê°€ê²©ê³¼ ì—°ê°„ ì†Œë“ì„ 0ë³´ë‹¤ í° ê°’ìœ¼ë¡œ ì •í™•íˆ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
                 errorMessageDiv.classList.remove('hidden');
                 return; // Exit function if input is missing
            }

            // *** UPDATED: Validation Check (Lottery Rates Sum) ***
            if (type === 'lottery') {
                // Validation is now just for contract rate, as balance is derived
                if (contractRateInput < 0 || contractRateInput > 40) {
                     errorMessageDiv.innerHTML = ' ğŸš¨  ê³„ì•½ê¸ˆ ë¹„ìœ¨ì€ 0%ì™€ 40% ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.';
                     errorMessageDiv.classList.remove('hidden');
                     return;
                }
                // Check if mid-loan rate exceeds total mid-payment rate (which is 60%)
                if (midRate > 60) { 
                    errorMessageDiv.innerHTML = ` ğŸš¨  ì¤‘ë„ê¸ˆ ëŒ€ì¶œì€ ìµœëŒ€ 60% (ì´ ì¤‘ë„ê¸ˆ ë¹„ìœ¨)ê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`;
                    errorMessageDiv.classList.remove('hidden');
                    return;
                }
            }
            
            // *** Validation Check (Multi-homeowner Loan Impossible Check) ***
            if (houses === 'multi') {
                 // *** UPDATED: Show warning in the *correct* section's content box ***
                 const warningBoxId = (type === 'buy') ? 'outlay-items' : 'loan-flow-content';
                 const warningBox = document.getElementById(warningBoxId);
                 
                 warningBox.innerHTML = '<div class="mt-4 p-3 bg-red-100 border border-red-400 rounded-lg text-red-700 font-semibold"><p> ğŸš¨  ë‹¤ì£¼íƒìëŠ” ì›ì¹™ì ìœ¼ë¡œ ì£¼íƒ ë‹´ë³´ ëŒ€ì¶œ (ì”ê¸ˆ ëŒ€ì¶œ)ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.</p></div>';
                 
                 // Show results section to display the warning
                 document.getElementById('result').classList.add('result-visible');
                 window.scrollTo({ top: document.getElementById('result').offsetTop - 20, behavior: 'smooth' });
                 return; // Exit function if multi-homeowner
            } 
            
            // [Logic kept]: Total available cash only uses 'Disposal Assets'
            const totalAvailableCash = disposalAssets; 
            // 1. Calculate Maximum Balance Loan (Minimum of LTV/DSR/Cap)
            const ltvAmt = price * currentLTV; // LTV Limit (ì–µ)
            const stress = (region === 'regulated') ? reg.stressRateReg : reg.stressRateNon;
            const dsrAmt = calculateDSRMaxPrincipal(income, rate, stress); // DSR Limit (ì–µ)
            let finalLoan = Math.min(ltvAmt, dsrAmt);
            if (isRegulatedCap) finalLoan = Math.min(finalLoan, priceCap); // Apply High-price Cap
            
            // Check the regulation source that determined the final loan limit
            let minSource = finalLoan === ltvAmt ? `LTV (${currentLTVRate})` : finalLoan === dsrAmt ? 'DSR (40%+ìŠ¤íŠ¸ë ˆìŠ¤)' : 'ê³ ê°€í•œë„';
            // 2. Calculate Incidental Costs
            const tax = price * reg.costs.taxRate; // Acquisition tax 3.3%
            let totalCost; // Total incidental costs
            
            // Pure incidental costs (Brokerage + Other)
            const pureIncidentalCosts = type === 'buy' ? (price * reg.costs.brokerageRate) + reg.costs.etc : 0; 
            if (type === 'buy') { 
                // General Purchase: Includes Acquisition tax, Brokerage fee, Other costs
                totalCost = tax + pureIncidentalCosts; 
                document.getElementById('outlay-note').classList.remove('hidden');
            } else { 
                // Subscription/Lottery: Only Acquisition tax (3.3%) considered (Brokerage, Other costs minor/not applicable at balance payment)
                totalCost = tax; 
                document.getElementById('outlay-note').classList.add('hidden');
            }
            
            // Mid-loan (Subscription Only)
            const midLoanPossible = type === 'lottery' ? price * (midRate / 100) : 0; // Group mid-loan amount (ì–µ)
            // ----------------------------------------------------
            // --- Section 1: Maximum Loan Details ---
            // ----------------------------------------------------
            let loanDetailHtml = '';
            if (type === 'lottery') {
                loanDetailHtml += `
                    <div class="p-3 bg-red-50 border border-red-300 rounded-lg mb-4">
                        <p class="text-sm font-semibold text-red-600 mb-1">ì¤‘ë„ê¸ˆ ëŒ€ì¶œ (ì´ ë¶„ì–‘ê°€ ëŒ€ë¹„ ${midRate.toFixed(0)}%)</p>
                        <span class="text-2xl font-extrabold text-red-700">${formatAmount(midLoanPossible, 1)}</span>
                        <p class="text-xs text-gray-500 mt-1">ì…ì£¼ ì‹œì  ì „ì•¡ ìƒí™˜ í•„ìˆ˜</p>
                    </div>
                `;
            }
            
            loanDetailHtml += `
                <div class="p-3 bg-blue-50 border border-primary rounded-lg">
                    <p class="text-sm font-semibold text-primary mb-1">ìµœëŒ€ ì”ê¸ˆ ëŒ€ì¶œê¸ˆ</p>
                    <span class="text-3xl font-extrabold text-primary">${formatAmount(finalLoan, 1)}</span>
                </div>
            `;
            
            let breakdownHtml = `
                <p class="text-sm text-gray-600">ê²°ì • ê·œì œ: <span class="font-bold text-red-600">${minSource}</span></p>
                <ul class="list-disc ml-5 text-xs text-gray-500 mt-2 space-y-1">
                    <li>LTV í•œë„: ${formatAmount(ltvAmt, 1)}</li>
                    <li>DSR í•œë„: ${formatAmount(dsrAmt, 1)}</li>
                    ${isRegulatedCap ? `<li>ê³ ê°€í•œë„: ${formatAmount(priceCap, 1)}</li>` : ''}
                </ul>
            `;
            
            document.getElementById('final-loan-detail').innerHTML = loanDetailHtml;
            document.getElementById('loan-breakdown').innerHTML = breakdownHtml;
            // 2. Cash Required (cashNeededForCalculation) Calculation
            const totalPurchasePrice = price + totalCost; // House price + Incidental costs (ì–µ)
            let cashRequired = 0;
            let outlayHtml = '';
            let cashNeededForCalculation = 0; // Net cash needed for comparison with available cash
            
            let totalProjectCostAplusB = 0;
            let cashSurplus = 0; // This will hold the final surplus/deficit
            let netCashNeededForFeasibility = 0; // For 'lottery' type, (A+B) - (Loan + Disposal)
            
            if (type === 'buy') {
                // *** UPDATED: 'BUY' TYPE LOGIC ***
                cashRequired = totalPurchasePrice - finalLoan; // Net cash needed before user assets
                cashNeededForCalculation = cashRequired; 
                
                cashSurplus = totalAvailableCash - cashRequired; // Final surplus (User Assets - Net Cash Required)
                netCashNeededForFeasibility = cashRequired;
                totalProjectCostAplusB = totalPurchasePrice; // Total project cost
                const totalFundsAvailable = finalLoan + disposalAssets;

                // --- NEW HTML for 'buy' type ---
                outlayHtml = `
                    <!-- 1. ì´ ë§¤ë§¤ ì†Œìš”ì•¡ -->
                    <div class="p-3 bg-gray-100 rounded-lg mb-4 border border-gray-300">
                        <p class="text-base font-bold text-gray-700 mb-2">ì´ ë§¤ë§¤ ì†Œìš”ì•¡ (${formatAmount(totalPurchasePrice, 1)})</p>
                        <div class="flex justify-between items-center text-sm border-b pb-1"><span>- ì£¼íƒ ë§¤ë§¤ê°€</span><span class="font-extrabold text-gray-700">${formatAmount(price, 1)}</span></div>
                        <div class="flex justify-between items-center text-sm"><span>- ë¶€ëŒ€ ë¹„ìš©(ì·¨ë“ì„¸ ë“±)</span><span class="font-extrabold text-gray-700">${formatAmount(totalCost, 1)}</span></div>
                    </div>
                    
                    <!-- 2. ğŸ¦ ì´ ì¡°ë‹¬ ê°€ëŠ¥ ê¸ˆì•¡ -->
                    <div class="p-3 bg-blue-50 rounded-lg mt-3 border border-primary">
                        <p class="text-base font-bold text-primary mb-2"> ğŸ¦ ì´ ì¡°ë‹¬ ê°€ëŠ¥ ê¸ˆì•¡ (ëŒ€ì¶œ + ìì‚°)</p>
                        <div class="flex justify-between items-center text-sm"><span>ìµœëŒ€ ì”ê¸ˆ ëŒ€ì¶œê¸ˆ</span><span class="text-primary-600 font-extrabold text-primary">${formatAmount(finalLoan, 1)}</span></div>
                        <div class="flex justify-between items-center text-sm"><span>ë³´ìœ  ìì‚° ì²˜ë¶„ì•¡</span><span class="text-secondary-600 font-extrabold text-secondary">${formatAmount(disposalAssets, 1)}</span></div>
                        <div class="flex justify-between items-center text-base font-extrabold pt-2 border-t mt-2 text-primary">
                            <span>ì´ ì¡°ë‹¬ ê°€ëŠ¥ ê¸ˆì•¡ í•©ì‚°</span>
                            <span>${formatAmount(totalFundsAvailable, 1)}</span>
                        </div>
                    </div>

                    <!-- 3. ğŸ”¥ ìµœì¢… í˜„ê¸ˆ ì—¬ìœ ì•¡ ì‚°ì¶œ -->
                    <div class="p-4 bg-white rounded-xl mt-6 shadow-md border border-gray-200" id="cash-flow-summary-buy">
                        <h4 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">3. ìµœì¢… í˜„ê¸ˆ ì—¬ìœ ì•¡ ì‚°ì¶œ</h4>
                        
                        <div class="p-3 bg-blue-50 rounded-lg border border-primary/50">
                            <div class="flex justify-between items-center text-sm border-b pb-1">
                                <span>ì´ ë§¤ë§¤ ì†Œìš”ì•¡</span>
                                <span class="font-extrabold text-gray-800">${formatAmount(totalPurchasePrice, 1)}</span>
                            </div>
                            
                            <div class="flex justify-between items-center text-sm border-b border-dashed pb-1">
                                <span>- ìµœëŒ€ ì”ê¸ˆ ëŒ€ì¶œê¸ˆ</span>
                                <span class="font-bold text-primary">(-) ${formatAmount(finalLoan, 1)}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm border-b border-dashed pb-1">
                                <span>- ë³´ìœ  ìì‚° ì²˜ë¶„ì•¡</span>
                                <span class="font-bold text-secondary">(-) ${formatAmount(disposalAssets, 1)}</span>
                            </div>
                            
                            <!-- Final calculated result -->
                            <div class="flex justify-between items-center text-base pt-3 border-t-2 border-primary mt-2">
                                <span class="font-extrabold">í˜„ê¸ˆ ì—¬ìœ ì•¡</span>
                                <span class="text-2xl font-extrabold ${cashSurplus >= 0 ? 'text-secondary' : 'text-warning'}">
                                    ${cashSurplus >= 0 ? formatAmount(cashSurplus, 1) : formatAmount(Math.abs(cashSurplus), 1) + ' (ë¶€ì¡±)'}
                                </span>
                            </div>

                            <!-- Feasibility Status -->
                            <div class="text-center mt-3 pt-2 border-t border-primary/50">
                                <span class="text-lg font-extrabold ${cashSurplus >= 0 ? 'text-secondary' : 'text-warning'}">
                                    ${cashSurplus >= 0 ? ' âœ… ë§¤ë§¤ ê°€ëŠ¥' : ' âŒ í˜„ê¸ˆ í™•ë³´ í•„ìš”'}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('outlay-items').innerHTML = outlayHtml;

            } else {
                // **Subscription/Lottery Logic (Reflected Request)**
                
                // *** UPDATED: Subscription price details (from Input) ***
                const contractRate = contractRateInput / 100; // e.g. 0.1
                const balanceRate = balanceRateInput / 100; // e.g. 0.3 (derived)
                // *** UPDATED: Mid payment rate is now fixed at 0.6 (60%) ***
                const totalMidPaymentRate = 0.6; // 1 - 0.1 - 0.3 = 0.6
                
                const contractDeposit = price * contractRate; // Deposit
                const totalMidPayment = price * totalMidPaymentRate; // Total mid-payment (60%)
                const balancePayment = price * balanceRate; // Balance payment (derived)
                
                const midPaymentLoanRate = midRate / 100; // Group mid-loan rate (e.g., 0.4)
                const midPaymentRateDisplay = midRate.toFixed(0); // For display (e.g., 40%)

                // A. Cash Outlay Before Entry (Deposit + Self-paid Mid-payment)
                // (ì´ ì¤‘ë„ê¸ˆ ë¹„ìœ¨(0.6) - ì¤‘ë„ê¸ˆ ëŒ€ì¶œ ë¹„ìœ¨)
                const cashForMidPaymentRate = Math.max(0, totalMidPaymentRate - midPaymentLoanRate); // (e.g., 0.6 - 0.4 = 0.2)
                const cashForMidPayment = price * cashForMidPaymentRate; // Cash portion of mid-payment (ì–µ)
                const cashSpentBeforeEntry = contractDeposit + cashForMidPayment; // (A) Total cash required before entry
                
                // B. Total Required at Entry (Before Loan/Asset reflection)
                // Balance payment + Mid-loan repayment (loanFromMid) + Acquisition tax
                const loanFromMid = midLoanPossible; // price * midPaymentLoanRate (e.g. 10ì–µ * 0.4 = 4ì–µ)
                const totalNeedAtEntry = balancePayment + loanFromMid + tax; // (B) Total required at entry
                
                // I. Cash Required Before Entry (A)
                const requiredCashA = cashSpentBeforeEntry;
                // II. Cash Required At Entry (B) - Balance/Mid-loan repayment/Acquisition tax
                const requiredCashB = totalNeedAtEntry; 
                // III. Total Cash Required (A + B) - Total Project Cost
                totalProjectCostAplusB = requiredCashA + requiredCashB; // Deposit+Self-paid Mid + Balance+Mid-loan repayment+Tax
                // IV. Total Available Funds
                const totalFundsAvailable = finalLoan + disposalAssets;
                // V. Final Cash Surplus (A+B) - (Loan + Disposal Assets)
                cashSurplus = totalFundsAvailable - totalProjectCostAplusB;
                
                // Net cash needed for feasibility comparison
                netCashNeededForFeasibility = totalProjectCostAplusB - totalFundsAvailable;
                cashNeededForCalculation = Math.max(0, netCashNeededForFeasibility); // Keep comparison standard for 'Total Summary' section
                
                // **Apply UI Illustration: Cash Required and Final Surplus Section Integrated**
                outlayHtml = `
                    <!-- 1. Total Subscription Price Details -->
                    <div class="p-3 bg-gray-100 rounded-lg mb-4 border border-gray-300">
                        <p class="text-base font-bold text-gray-700 mb-2">ì´ ë¶„ì–‘ê°€ ìƒì„¸ (${formatAmount(price)})</p>
                        <div class="flex justify-between items-center text-sm border-b pb-1"><span>- ê³„ì•½ê¸ˆ (${(contractRate * 100).toFixed(0)}%)</span><span class="font-extrabold text-gray-700">${formatAmount(contractDeposit, 1)}</span></div>
                        <div class="flex justify-between items-center text-sm border-b pb-1"><span>- ì¤‘ë„ê¸ˆ (${(totalMidPaymentRate * 100).toFixed(0)}%)</span><span class="font-extrabold text-gray-700">${formatAmount(totalMidPayment, 1)}</span></div>
                        <div class="flex justify-between items-center text-sm"><span>- ì”ê¸ˆ (${(balanceRate * 100).toFixed(0)}%)</span><span class="font-extrabold text-gray-700">${formatAmount(balancePayment, 1)}</span></div>
                    </div>
                    <!-- 2.  ğŸ¦  Total Available Funds -->
                    <div class="p-3 bg-blue-50 rounded-lg mt-3 border border-primary">
                        <p class="text-base font-bold text-primary mb-2"> ğŸ¦  ì´ ì¡°ë‹¬ ê°€ëŠ¥ ê¸ˆì•¡ (ëŒ€ì¶œ + ìì‚°)</p>
                        <div class="flex justify-between items-center text-sm"><span>ìµœëŒ€ ì”ê¸ˆ ëŒ€ì¶œê¸ˆ</span><span class="text-primary-600 font-extrabold text-primary">${formatAmount(finalLoan, 1)}</span></div>
                        <div class="flex justify-between items-center text-sm"><span>ë³´ìœ  ìì‚° ì²˜ë¶„ì•¡</span><span class="text-secondary-600 font-extrabold text-secondary">${formatAmount(disposalAssets, 1)}</span></div>
                        <!-- NEW: Total Sum -->
                        <div class="flex justify-between items-center text-base font-extrabold pt-2 border-t mt-2 text-primary">
                            <span>ì´ ì¡°ë‹¬ ê°€ëŠ¥ ê¸ˆì•¡ í•©ì‚°</span>
                            <span>${formatAmount(totalFundsAvailable, 1)}</span>
                        </div>
                    </div>
                    <!-- 3.  ğŸ”¥  Calculation of Cash to be Held (NEW UNIFIED SECTION) -->
                    <div class="p-4 bg-white rounded-xl mt-6 shadow-md border border-gray-200" id="cash-flow-summary-new">
                        <h4 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">3. ë³´ìœ í•´ì•¼ í•˜ëŠ” í˜„ê¸ˆ ì‚°ì¶œ</h4>
                        
                        <!-- 3-1. I. Cash Required Before Entry (A) -->
                        <div class="mb-4 p-3 bg-green-50 rounded-lg border border-green-300">
                            <p class="text-base font-bold text-green-700 mb-2 border-b pb-1">I. ì…ì£¼ ì „ í•„ìš” í˜„ê¸ˆ(A)</p>
                            <div class="flex justify-between items-center text-sm"><span>- ê³„ì•½ê¸ˆ(${(contractRate * 100).toFixed(0)}%)</span><span class="font-extrabold text-green-600">${formatAmount(contractDeposit, 1)}</span></div>
                            <div class="flex justify-between items-center text-sm"><span>- ìë‚© ì¤‘ë„ê¸ˆ(${(cashForMidPaymentRate * 100).toFixed(0)}%)</span><span class="font-extrabold text-green-600">${formatAmount(cashForMidPayment, 1)}</span></div>
                            <div class="flex justify-between items-center text-base font-extrabold pt-2 border-t mt-2 text-green-800">
                                <span>ì…ì£¼ ì „ í˜„ê¸ˆ ì§€ì¶œ í•©ê³„</span>
                                <span>${formatAmount(requiredCashA, 1)}</span>
                            </div>
                        </div>
                        <!-- 3-2. II. Total Required At Entry (B) -->
                        <div class="mb-4 p-3 bg-red-50 rounded-lg border border-warning">
                            <p class="text-base font-bold text-warning mb-2 border-b pb-1">II. ì…ì£¼ ì‹œ ì´ ì†Œìš”ì•¡(B)</p>
                            
                            <div class="flex justify-between items-center text-sm border-b pb-1">
                                <span>+ ì¤‘ë„ê¸ˆ ì§‘ë‹¨ëŒ€ì¶œ ìƒí™˜(${midPaymentRateDisplay}%)</span>
                                <span class="font-bold text-red-600">${formatAmount(loanFromMid, 1)}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm border-b pb-1">
                                <span>+ ì”ê¸ˆ(${(balanceRate * 100).toFixed(0)}%)</span>
                                <span class="font-bold text-red-600">${formatAmount(balancePayment, 1)}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span>+ ì·¨ë“ì„¸(3.3%)</span>
                                <span class="font-bold text-red-600">${formatAmount(tax, 1)}</span>
                            </div>
                            <!-- NEW: Name Changed -->
                            <div class="flex justify-between items-center text-base font-extrabold pt-2 border-t mt-2 text-warning">
                                <span>ì…ì£¼ í›„ í˜„ê¸ˆ ì§€ì¶œ í•©ê³„</span>
                                <span>${formatAmount(requiredCashB, 1)}</span>
                            </div>
                        </div>
                        <!-- 3-3. III. Final Cash Surplus Calculation -->
                        <div class="p-3 bg-blue-50 rounded-lg border border-primary/50">
                            <p class="text-base font-bold text-primary mb-2 border-b pb-1">III. ìµœì¢… í˜„ê¸ˆ ì—¬ìœ ì•¡ ì‚°ì¶œ</p>
                            
                            <div class="flex justify-between items-center text-sm border-b pb-1">
                                <span>ì…ì£¼ ì „í›„ í•„ìš”í•œ í˜„ê¸ˆ(A+B)</span>
                                <span class="font-extrabold text-gray-800">${formatAmount(totalProjectCostAplusB, 1)}</span>
                            </div>
                            
                            <!-- UPDATED: Split deduction -->
                            <div class="flex justify-between items-center text-sm border-b border-dashed pb-1">
                                <span>- ìµœëŒ€ ì”ê¸ˆ ëŒ€ì¶œê¸ˆ</span>
                                <span class="font-bold text-primary">(-) ${formatAmount(finalLoan, 1)}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm border-b border-dashed pb-1">
                                <span>- ë³´ìœ  ìì‚° ì²˜ë¶„ì•¡</span>
                                <span class="font-bold text-secondary">(-) ${formatAmount(disposalAssets, 1)}</span>
                            </div>
                            
                            <!-- Final calculated result -->
                            <div class="flex justify-between items-center text-base pt-3 border-t-2 border-primary mt-2">
                                <span class="font-extrabold">í˜„ê¸ˆ ì—¬ìœ ì•¡</span>
                                <span class="text-2xl font-extrabold ${cashSurplus >= 0 ? 'text-secondary' : 'text-warning'}">
                                    ${cashSurplus >= 0 ? formatAmount(cashSurplus, 1) : formatAmount(Math.abs(cashSurplus), 1) + ' (ë¶€ì¡±)'}
                                </span>
                            </div>
                            <!-- NEW: Feasibility Status -->
                            <div class="text-center mt-3 pt-2 border-t border-primary/50">
                                <span class="text-lg font-extrabold ${cashSurplus >= 0 ? 'text-secondary' : 'text-warning'}">
                                    ${cashSurplus >= 0 ? ' âœ…  ì²­ì•½ ê°€ëŠ¥' : ' âŒ  í˜„ê¸ˆ í™•ë³´ í•„ìš”'}
                                </span>
                            </div>
                        </div>
                    </div>
                    <!-- Deleted line: ì´ í˜„ê¸ˆ ì§€ì¶œ í•©ê³„ (í”„ë¡œì íŠ¸ ìˆœìˆ˜ íˆ¬ì… í˜„ê¸ˆ) -->
                `;
                document.getElementById('loan-flow-content').innerHTML = outlayHtml;
            }
            // ----------------------------------------------------
            // --- Section 3: Monthly Repayment Simulation ---
            // ----------------------------------------------------
            const months = reg.term * 12; // 360 months
            const principal = finalLoan * 100000000; // Principal (Won)
            
            // Level Payment
            const level = calculateLevelPayment(principal, rate, months);
            const totalRepayLevel = level * months;
            
            // Equal Principal (1st month standard)
            const equalPrincipalFirstMonth = calculateEqualPrincipal(principal, rate, 1);
            
            // Total Repayment for Equal Principal (Interest included)
            const totalPrincipal = principal;
            const finalMonthlyRate = (rate / 100) / 12;
            // Total Interest: P * r * (n+1) / 2
            const totalInterestEqualPrincipal = principal * finalMonthlyRate * (months + 1) / 2;
            const totalRepayEqualPrincipal = totalPrincipal + totalInterestEqualPrincipal;
            
            document.getElementById('monthly-equal-principal').innerHTML = formatMonthly(equalPrincipalFirstMonth);
            document.getElementById('total-equal-principal-repay').innerHTML = formatTotalRepay(totalRepayEqualPrincipal);
            
            document.getElementById('monthly-level-payment').innerHTML = formatMonthly(level);
            document.getElementById('total-level-repay').innerHTML = formatTotalRepay(totalRepayLevel);
            
            document.getElementById('total-loan-display').innerHTML = finalLoan.toFixed(1);
            
            // ----------------------------------------------------
            // --- Section 4: (NOW DISABLED) ---
            // ----------------------------------------------------
            if (type === 'buy') {
                // *** UPDATED: This logic is now merged into Section 2 ***
                // Clear any potential leftover data
                document.getElementById('total-summary').innerHTML = "";
                document.getElementById('feasibility').innerHTML = "";
                document.getElementById('final-warning-box').innerHTML = "";
                
            } else {
                // 'lottery' type - Add residency requirement warning
                
                // We will append the warning *after* the loan-flow-content
                let lotteryWarningHtml = '';
                if (finalLoan > 0) {
                     lotteryWarningHtml = `
                        <div class="mt-4 p-3 bg-yellow-100 border border-yellow-400 rounded-lg text-yellow-700 font-semibold">
                            <p> ğŸš¨  <strong>ì¤‘ìš” ê²½ê³ :</strong> ì”ê¸ˆ ëŒ€ì¶œ(ì£¼ë‹´ëŒ€)ì„ ë°›ìœ¼ë ¤ë©´, <span class="text-red-600">ëŒ€ì¶œ ì‹¤í–‰ í›„ 6ê°œì›” ì´ë‚´ ì „ì… ì˜ë¬´</span>ê°€ ë°œìƒí•©ë‹ˆë‹¤. <span class="text-red-600">ì „ì„¸ ë³´ì¦ê¸ˆìœ¼ë¡œ ì”ê¸ˆ/ì¤‘ë„ê¸ˆ ìƒí™˜ì€ ë¶ˆê°€í•©ë‹ˆë‹¤.</p>
                        </div>
                    `;
                }
                // Append this warning to the 'loan-flow-content' div
                document.getElementById('loan-flow-content').innerHTML += lotteryWarningHtml;
            }
            // Display results (only runs if calculation completed successfully)
            const resultDiv = document.getElementById('result');
            resultDiv.classList.add('result-visible');
            window.scrollTo({ top: resultDiv.offsetTop - 20, behavior: 'smooth' });
        }
        
        // Initialization
        window.onload = function() {
            // Update loan regulation logic and UI visibility upon initial load
            updateRules();
            toggleMidLoan();
            showCap();
            // *** NEW: Initialize balance rate on load ***
            updateBalanceRate();
        }
        // Add listeners to update rules immediately when input values change
        document.getElementById('price').addEventListener('input', () => {
             updateRules(); 
             showCap();
        });
        document.getElementById('region').addEventListener('change', () => {
             updateRules();
             showCap();
        });
        document.getElementById('houses').addEventListener('change', () => {
             updateRules();
             showCap();
        });
        document.getElementById('type').addEventListener('change', () => {
             updateRules();
             showCap();
             // *** NEW: Update balance rate when type changes ***
             updateBalanceRate();
        });
    </script>
</body>
</html>
