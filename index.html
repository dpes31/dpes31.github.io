<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 부동산 투자 시뮬레이터 (11.10 최신)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 16px; background: #f8f9fa; color: #212529; line-height: 1.5; }
        h1 { font-size: 1.5rem; text-align: center; margin: 0 0 24px; }
        .desc { text-align: center; font-size: 0.9rem; color: #6c757d; margin-bottom: 24px; }
        form { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        label { display: block; font-size: 0.95rem; font-weight: 600; margin: 16px 0 6px; }
        input, select { width: 100%; padding: 12px; font-size: 1rem; border: 1.5px solid #ced4da; border-radius: 8px; background: #fff; }
        input:focus, select:focus { border-color: #007bff; outline: none; }
        input::placeholder { color: #adb5bd; }
        .mid-loan { display: none; }
        .special-note { display: none; background: #e7f3ff; padding: 12px; border-radius: 8px; margin-top: 8px; font-size: 0.9rem; }
        /* 버튼 스타일 수정: 영역 및 폰트 강조 */
        button { 
            margin-top: 24px; 
            width: 100%; 
            padding: 16px; 
            background: linear-gradient(135deg, #007bff, #0056b3); /* 그라데이션 추가 */
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-size: 1.2rem; /* 영역 확장 */
            font-weight: 800; /* 굵게 */
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4); /* 그림자 추가 */
            transition: all 0.2s ease-in-out;
        }
        button:hover { 
            background: linear-gradient(135deg, #0056b3, #007bff); 
            box-shadow: 0 6px 15px rgba(0, 123, 255, 0.6);
            transform: translateY(-1px);
        }
        button:active { 
            background: #0056b3; 
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #result { margin-top: 32px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: none; }
        .section { margin-bottom: 32px; padding: 20px; background: #f8f9fa; border-radius: 12px; border: 1px solid #dee2e6; }
        .section h3 { margin: 0 0 16px; font-size: 1.2rem; color: #495057; border-bottom: 2px solid #007bff; padding-bottom: 8px; }
        /* 모바일 최적화 수정 */
        .item { 
            display: flex; 
            justify-content: space-between; 
            padding: 10px 0; 
            border-bottom: 1px dashed #ced4da; 
            font-size: 1rem;
            flex-wrap: wrap;
        }
        .item strong { 
            color: #212529; 
            flex-basis: auto; 
            max-width: 70%;
            word-break: break-word;
        }
        .item:last-child { border-bottom: none; }
        .amount { 
            font-weight: bold; 
            color: #007bff; 
            white-space: nowrap; 
            margin-left: auto;
        }
        .big-amount { 
            font-weight: bold; 
            color: #d9480f; 
            white-space: nowrap;
            margin-left: auto;
        }
        .total-outlay { font-size: 1.8rem; }
        /* 대출 금액 음영 스타일 */
        .loan-bg {
            background-color: #e6f7ff; /* 연한 하늘색 음영 */
            padding: 2px 6px;
            border-radius: 4px;
        }
        /* 중도금 대출 금액 파란색으로 표기 (요청 사항 반영) */
        .mid-loan-amount {
            color: #007bff !important;
        }
        /* 기존 스타일 유지 */
        .final-loan { background: #ffe5e5; border: 3px solid #dc3545; padding: 16px; border-radius: 12px; text-align: center; }
        .summary { background: #fff9db; padding: 20px; border-radius: 12px; border: 2px solid #ffc107; }
        .summary .item { font-size: 1.1rem; padding: 12px 0; }
        .highlight { color: #007bff; font-weight: bold; font-size: 1.3rem; }
        .possible { color: #28a745; font-weight: bold; font-size: 1.4rem; }
        .impossible { color: #dc3545; font-weight: bold; font-size: 1.4rem; }
        table { width: 100%; border-collapse: collapse; margin: 16px 0; }
        th, td { padding: 8px; border: 1px solid #dee2e6; text-align: center; }
        th { background: #e7f3ff; }
        #interest-section { margin-top: 32px; padding: 20px; background: #f8f9fa; border-radius: 12px; }
        #interest-section h3 { font-size: 1.1rem; margin: 0 0 16px; color: #495057; text-align: center; }
        .repay-box { display: flex; justify-content: space-around; gap: 16px; }
        .repay-card { flex: 1; background: white; padding: 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
        .repay-card.recommend { border: 3px solid #007bff; }
        .repay-card h4 { margin: 0 0 8px; font-size: 1rem; color: #495057; }
        .repay-card .monthly { font-size: 1.4rem; font-weight: bold; color: #007bff; margin: 8px 0; }
        .repay-card small { display: block; color: #6c757d; font-size: 0.8rem; margin-top: 8px; line-height: 1.4; }
        .tip-box { margin-top: 32px; padding: 16px; background: #e9f7ff; border-left: 4px solid #007bff; border-radius: 0 8px 8px 0; font-size: 0.9rem; color: #495057; line-height: 1.6; }
        .tip-box strong { color: #007bff; }
        .small-note { font-size: 0.8rem; color: #6c757d; margin-top: 16px; }
        .sub-item { padding-left: 20px; font-size: 0.95rem; color: #495057; }
        .convertible { color: #dc3545; font-weight: bold; }
        .self-mid { color: #007bff; font-weight: bold; }
        .ltv-display { font-size: 1.2rem; font-weight: bold; color: #d9480f; margin: 12px 0; text-align: center; background: #fff; padding: 12px; border-radius: 8px; }
        .cap-display { font-size: 1.1rem; font-weight: bold; color: #dc3545; margin: 12px 0; text-align: center; background: #fff; padding: 12px; border-radius: 8px; display: none; }

        /* 주석 스타일 조정 */
        .loan-note { 
            font-size: 0.85rem; 
            color: #6c757d; 
            text-align: right; 
            padding: 4px 0 10px;
            line-height: 1.3;
        }
        .policy-btn {
            display: inline-block; 
            margin: 8px 0; 
            padding: 6px 12px; 
            background: #007bff; 
            color: white; 
            text-decoration: none; 
            border-radius: 6px; 
            font-weight: 600;
            font-size: 0.9rem;
        }
        #loan-flow-content h4 {
            font-size: 1.1rem;
            color: #007bff;
            border-bottom: 1px solid #007bff;
            padding-bottom: 4px;
            margin-top: 20px;
            margin-bottom: 12px;
        }
        .loan-flow-item strong {
            font-size: 1rem;
        }
        .note-red {
            color: #dc3545; 
            font-size: 0.9rem; 
            font-weight: bold;
            padding-left: 20px;
            margin-top: 4px;
            display: block;
        }
    </style>
</head>
<body>
    <h1>2025 부동산 투자 시뮬레이터</h1>
    <!-- 선택 영역 수정 -->
    <p class="desc">2025.10.15 규제 (금융위원회 FAQ)</p>
    <form id="simulatorForm">
        <label>주택 유형</label>
        <select id="type" onchange="toggleMidLoan(); updateRules()">
            <option value="buy">일반 매매</option>
            <option value="lottery">청약/분양</option>
        </select>
        <label>주택 가격 (억 원)</label>
        <input type="number" id="price" placeholder="10" step="0.1" oninput="updateRules(); showCap()">
        <label>투자 지역</label>
        <select id="region" onchange="updateRules()">
            <option value="regulated">규제지역 (수도권 등)</option>
            <option value="non">비규제지역</option>
        </select>
        <label>보유 주택 수</label>
        <select id="houses" onchange="updateRules()">
            <option value="0">무주택</option>
            <option value="1">1주택</option>
            <option value="multi">다주택</option>
        </select>
        <label>서민·실수요자 우대</label>
        <select id="special" onchange="updateRules()">
            <option value="no">아니오</option>
            <option value="yes">예 (무주택+소득1억이하+9억이하)</option>
        </select>
        <div id="special-note" class="special-note">
            <!-- 날짜 수정 -->
            우대 적용 시 규제지역 LTV 70%, 비규제 80% (2025.10.15~ 미적용, 보수적 40/70% 유지)
        </div>
        <div class="ltv-display" id="ltv-display">LTV: 계산 중...</div>
        <div class="cap-display" id="cap-display">고가한도: 적용 중...</div>
        <label>보유 자산 (억 원)</label>
        <input type="number" id="assets" placeholder="3" step="0.1">
        <label>연간 소득 (세전, 억 원)</label>
        <input type="number" id="income" placeholder="1" step="0.1">
        <div class="mid-loan">
            <label>건설사 중도금 대출 비율 (%)</label>
            <input type="number" id="midLoanRate" placeholder="40" step="5" min="0" max="60">
        </div>
        <label>대출 금리 (%)</label>
        <input type="number" id="interestRate" placeholder="4.0" step="0.1">
        <button type="button" onclick="calculate()">계산하기</button>
    </form>
    <div id="result">
        <h2 style="margin-top:0; font-size:1.3rem; text-align:center;">투자 분석 결과</h2>
        
        <!-- 대출 한도 섹션 (1) -->
        <div class="section" id="section-loan-limit">
            <h3>1. 대출 한도 및 최대 대출금</h3>
            <div id="final-loan-detail"></div>
            <div id="loan-breakdown"></div>
            <table id="cap-table" style="display:none;">
                <tr><th>주택가격</th><th>최대 한도</th></tr>
                <tr><td>15억 이하</td><td>6억</td></tr>
                <tr><td>15~25억</td><td>4억</td></tr>
                <tr><td>25억 초과</td><td>2억</td></tr>
            </table>
        </div>
        
        <!-- 매매/청약 개요 및 현금 필요액 섹션 (2) - 청약 시 숨김 -->
        <div class="section" id="section-outlay">
            <h3 id="outlay-title">2. 매매 개요 및 총 현금 필요액</h3>
            <div id="outlay-items"></div>
            <!-- 비용 기준 수정 -->
            <p class="small-note">취득세 3.3% + 중개 보수료 0.6% + 기타 0.1억 (실제 금액과 다를 수 있습니다)</p>
        </div>

        <!-- 대출 단계별 현금 흐름 섹션 (청약 전용) (3 -> 2로 변경) -->
        <div class="section" id="loan-flow-section" style="display:none;">
            <h3>2. 현금 흐름 상세 분석 (청약)</h3>
            <div id="loan-flow-content"></div>
        </div>

        <!-- 총 정리 섹션 (4 -> 3으로 변경) -->
        <div class="section summary" id="section-summary">
            <h3>3. 총 정리</h3>
            <div id="total-summary"></div>
            <p id="feasibility" style="text-align:center; margin:20px 0 0 0;"></p>
        </div>
        
        <!-- 이자 상환 섹션 -->
        <div id="interest-section">
            <h3><span id="total-loan-display"></span>억 대출 월 상환 (30년)</h3>
            <div class="repay-box">
                <div class="repay-card recommend">
                    <h4>원금 균등</h4>
                    <div class="monthly" id="monthly-equal-principal"></div>
                    <small>총이자 ↓</small>
                </div>
                <div class="repay-card">
                    <h4>원리금 균등</h4>
                    <div class="monthly" id="monthly-level-payment"></div>
                    <small>매월 동일</small>
                </div>
            </div>
        </div>
        <div class="tip-box">
            <!-- 1. 날짜 수정 및 버튼 추가 -->
            <strong>2025.10.15 규제 (금융위원회 FAQ)</strong>
            <br>
            <a href="https://www.fsc.go.kr/po020201/85518?srchCtgry=&curPage=&srchKey=&srchText=&srchBeginDt=&srchEndDt=" target="_blank" class="policy-btn">[주요 정책 보기]</a>
            <br>
            • 규제지역 LTV 40% (다주택 0%, 중도금/이주비 제외)<br>
            • 수도권·규제지역 고가한도: 15억이하 6억, 15-25억 4억, 25억초과 2억<br>
            • 스트레스 DSR 금리 3.0% (비규제 제외)<br>
            • 생활안정자금 주담대 제외
        </div>
    </div>
    <script>
        const reg = {
            dsrRate: 0.4,
            stressRateReg: 0.03,  // 규제 3.0%
            stressRateNon: 0,     // 비규제 0% (보수적)
            costs: { 
                taxRate: 0.033,       // 취득세 3.3% (사용자 요청)
                brokerageRate: 0.006, // 중개 보수료 0.6% (사용자 요청)
                etc: 0.1              // 기타 비용 (고정)
            },
            defaultRate: 4.0,
            term: 30
        };
        let currentLTV = 0;
        let currentLTVRate = '';
        let priceCap = 999;
        let isRegulatedCap = false;

        function toggleMidLoan() {
            const isLottery = document.getElementById('type').value === 'lottery';
            document.querySelector('.mid-loan').style.display = isLottery ? 'block' : 'none';
            document.getElementById('cap-table').style.display = 'none';
            updateRules();
        }

        function showCap() {
            const price = parseFloat(document.getElementById('price').value) || 0;
            const region = document.getElementById('region').value;
            if (region === 'regulated' && price > 15) {
                let cap = price > 25 ? 2 : 4;
                if (price <= 15) cap = 6;
                document.getElementById('cap-display').innerHTML = `고가한도 적용: 최대 ${cap}억`;
                document.getElementById('cap-display').style.display = 'block';
            } else {
                document.getElementById('cap-display').style.display = 'none';
            }
        }

        function updateRules() {
            const region = document.getElementById('region').value;
            const houses = document.getElementById('houses').value;
            const special = document.getElementById('special').value;
            const price = parseFloat(document.getElementById('price').value) || 0;
            const type = document.getElementById('type').value;
            
            document.getElementById('special-note').style.display = special === 'yes' ? 'block' : 'none';

            if (houses === 'multi') {
                currentLTV = 0;
                currentLTVRate = '다주택 0%';
                document.getElementById('ltv-display').innerHTML = '다주택: LTV 0% (대출 불가)';
                return;
            }

            let base = region === 'regulated' ? 0.4 : 0.7;
            let rateStr = region === 'regulated' ? '40%' : '70%';
            currentLTV = base;
            currentLTVRate = rateStr;
            document.getElementById('ltv-display').innerHTML = `LTV ${rateStr} → 최대 ${(price * currentLTV).toFixed(1)}억`;

            isRegulatedCap = (region === 'regulated');
            if (isRegulatedCap) {
                priceCap = price > 25 ? 2 : (price > 15 ? 4 : 6);
                document.getElementById('cap-table').style.display = 'table';
                showCap();
            } else {
                priceCap = 999;
                document.getElementById('cap-table').style.display = 'none';
            }

            // 섹션 번호 조정 및 가시성 관리
            if (type === 'lottery') {
                document.getElementById('section-outlay').style.display = 'none';
                document.getElementById('section-loan-limit').querySelector('h3').textContent = '1. 대출 한도 및 최대 대출금';
                document.getElementById('loan-flow-section').style.display = 'block';
                document.getElementById('loan-flow-section').querySelector('h3').textContent = '2. 현금 흐름 상세 분석 (청약)';
                document.getElementById('section-summary').querySelector('h3').textContent = '3. 총 정리';
            } else {
                document.getElementById('section-outlay').style.display = 'block';
                document.getElementById('section-loan-limit').querySelector('h3').textContent = '1. 대출 한도 및 최대 대출금';
                document.getElementById('section-outlay').querySelector('h3').textContent = '2. 매매 개요 및 총 현금 필요액';
                document.getElementById('loan-flow-section').style.display = 'none';
                document.getElementById('section-summary').querySelector('h3').textContent = '3. 총 정리';
            }
        }

        function calculateDSRMaxPrincipal(annualIncome, annualRate, stress) {
            if (annualIncome <= 0) return 0;
            const stressAdj = annualRate / 100 + stress;
            const monthlyIncome = annualIncome * 100000000 / 12;
            const monthlyRate = stressAdj / 12;
            const months = reg.term * 12;
            const dsrMonthly = monthlyIncome * reg.dsrRate;

            if (monthlyRate <= 0) return (dsrMonthly * months) / 100000000;
            
            const pow = Math.pow(1 + monthlyRate, months);
            const maxP = dsrMonthly * (pow - 1) / (monthlyRate * pow);
            return maxP / 100000000; // 억
        }

        function calculate() {
            const type = document.getElementById('type').value;
            const price = parseFloat(document.getElementById('price').value) || 0;
            const assets = parseFloat(document.getElementById('assets').value) || 0;
            const income = parseFloat(document.getElementById('income').value) || 0;
            const rate = parseFloat(document.getElementById('interestRate').value) || reg.defaultRate;
            const region = document.getElementById('region').value;
            const midRate = type === 'lottery' ? parseFloat(document.getElementById('midLoanRate').value) || 40 : 0;
            
            // 1. 최대 잔금 대출금 (LTV/DSR/Cap 중 최소값) 계산
            const ltvAmt = price * currentLTV;
            const stress = (region === 'regulated') ? reg.stressRateReg : reg.stressRateNon;
            const dsrAmt = calculateDSRMaxPrincipal(income, rate, stress);
            let finalLoan = Math.min(ltvAmt, dsrAmt);
            if (isRegulatedCap) finalLoan = Math.min(finalLoan, priceCap);
            let minSource = finalLoan === ltvAmt ? `LTV (${currentLTVRate})` : finalLoan === dsrAmt ? 'DSR (40%+스트레스3%)' : '고가한도';

            // 2. 비용 계산 (수정된 3.3% 취득세 + 0.6% 중개 보수료 반영)
            const tax = price * reg.costs.taxRate;
            const brokerage = price * reg.costs.brokerageRate;
            const etc = reg.costs.etc;
            const totalCost = tax + brokerage + etc;
            
            let totalOutlay;
            
            // 청약 전용 섹션 초기화
            document.getElementById('loan-flow-content').innerHTML = '';


            // --- Section 1 Content Generation: 대출 한도 및 최대 대출금 ---
            let loanDetailHtml = '';
            let loanBreakdownHtml = '';
            
            const midLoanPossible = type === 'lottery' ? price * (midRate / 100) : 0; // 중도금 실행 가능액
            
            if (type === 'lottery') {
                // 1. 중도금 대출 실행금 (요청사항 1 반영)
                loanDetailHtml += `<h4 style="margin: 0 0 8px; color: #495057;">중도금 대출 실행금</h4>`;
                loanDetailHtml += `
                    <div class="final-loan" style="border: 3px solid #dc3545; background: #fff5f5; padding: 12px; margin-top: 10px; margin-bottom: 20px; text-align: center;">
                        <div class="big-amount loan-bg" style="font-size: 1.8rem; color: #dc3545; display: inline-block; background: transparent !important;">
                            ${midLoanPossible.toFixed(1)}억
                        </div>
                        <p class="small-note" style="text-align: center; margin: 5px 0 0;">(중도금 ${midRate}% 실행 기준)</p>
                    </div>
                `;
            }

            // 1. 잔금 대출 최대 실행금
            loanDetailHtml += `
                <h4 style="margin: 0 0 8px; color: #495057;">잔금 대출 최대 실행금</h4>
                <div class="final-loan" style="border: 3px solid #007bff; background: #e7f3ff; padding: 12px; margin-top: 10px; text-align: center;">
                    <div class="big-amount loan-bg" style="font-size: 1.8rem; color: #007bff; display: inline-block;">
                        ${finalLoan.toFixed(1)}억
                    </div>
                    <p class="small-note" style="text-align: center; margin: 5px 0 0;">(${minSource} 기준)</p>
                </div>
            `;

            loanBreakdownHtml = `<div style="margin-top: 16px;">
                <div class="item"><strong>LTV (${currentLTVRate})</strong> <span class="amount">${ltvAmt.toFixed(1)}억</span></div>
                <div class="item"><strong>DSR (40%+스트레스)</strong> <span class="amount">${dsrAmt.toFixed(1)}억</span></div>`;
            if (isRegulatedCap) loanBreakdownHtml += `<div class="item"><strong>고가한도</strong> <span class="amount">${priceCap}억</span></div>`;
            loanBreakdownHtml += '</div>';

            document.getElementById('final-loan-detail').innerHTML = loanDetailHtml;
            document.getElementById('loan-breakdown').innerHTML = loanBreakdownHtml;
            
            // --- Section 2 Content Generation: 현금 필요액 ---

            if (type === 'buy') {
                // 일반 매매 (기존 로직 유지)
                const cashOutlay = price - finalLoan + totalCost; // 총 필요 현금 = (주택가격 - 대출) + 비용
                totalOutlay = cashOutlay;

                outlayHtml = `<div class="item"><strong>주택가격</strong> <span class="amount">${price.toFixed(1)}억</span></div>
                    <div class="item"><strong>총 나갈 돈 (현금 필요액)</strong> <span class="big-amount total-outlay">${cashOutlay.toFixed(2)}억</span></div>
                    <div class="loan-note">(총 현금 필요액 = 주택가격 + 부대비용 - 최대 잔금 대출금)</div>
                    <div class="item" style="border-top: 1px dashed #ced4da;"><strong>├ 대출 제외 잔금</strong> <span class="amount">${(price - finalLoan).toFixed(2)}억</span></div>
                    <div class="item"><strong>├ 취득세 (3.3%)</strong> <span class="amount">${tax.toFixed(2)}억</span></div>
                    <div class="item"><strong>├ 중개 보수료 (0.6%)</strong> <span class="amount">${brokerage.toFixed(2)}억</span></div>
                    <div class="item"><strong>└ 기타 비용</strong> <span class="amount">${etc.toFixed(1)}억</span></div>`;
                document.getElementById('outlay-items').innerHTML = outlayHtml;
                
            } else {
                // 청약/분양

                const contract = price * 0.1;           // 계약금 (10%)
                const midTotal = price * 0.6;           // 중도금 총액 (60%)
                const midSelf = midTotal - midLoanPossible; // 중도금 중 자납 필요분 (20%)
                const balance = price * 0.3;            // 잔금 (30%)
                
                // 잔금 대출이 중도금 대환에 먼저 사용되고, 남은 대출액이 잔금 납부에 충당된다고 가정
                const finalLoanUsedToRepayMid = Math.min(finalLoan, midLoanPossible); // 잔금대출로 중도금 갚는 금액
                const loanForBalance = Math.max(0, finalLoan - finalLoanUsedToRepayMid); // 잔금 납부에 충당 가능한 잔금 대출액
                
                const midLoanNotFullyCovered = midLoanPossible > finalLoan ? midLoanPossible - finalLoan : 0; // 중도금 상환에 현금 필요분 (대출 한도 부족)
                
                // 요청사항: 총 잔금(30%) - 최대 잔금 대출(finalLoan) = 잔금 현금 필요액
                // 이 수식은 '중도금 대환'을 무시한 단순 계산이므로, 복합 로직 대신 요청하신 단순 잔금 현금 필요액을 계산합니다.
                // 잔금 납부에 충당할 수 있는 최대 대출액: 잔금(30%)과 최대 잔금 대출(finalLoan) 중 적은 금액을 대출로 충당 가능.
                const cashPaymentForBalanceSimple = Math.max(0, balance - finalLoan); // 단순 잔금 - 대출로 인한 현금 필요액
                const totalCashAtMoveInSimple = cashPaymentForBalanceSimple + totalCost;
                
                // **현금 지출 최종 금액 (요청사항의 의도를 반영한 복합 로직 사용)**
                // 계약금 (10%) + 자납 중도금 (20%) + 입주 시 현금 지출 (잔금 납부 현금 + 중도금 상환 부족분 + 부대비용)
                const cashOutAtMoveIn_step3_4 = midLoanNotFullyCovered + (balance - loanForBalance) + totalCost;
                const finalCashOutlay = contract + midSelf + cashOutAtMoveIn_step3_4; 
                
                // --- 3단계 내용 수정 (요청사항 반영) ---
                const balanceCashReq = Math.max(0, balance - finalLoan); // 잔금 30% 중 대출 한도 초과로 인해 현금으로 필요한 금액
                
                const loanFlowHtml = `
                    <h4>1단계: 계약금 납부 (10%)</h4>
                    <div class="item">
                        <strong>현금 지출액 (계약금)</strong> 
                        <span class="big-amount" style="color: #d9480f;">${contract.toFixed(2)}억</span>
                    </div>
                    <p class="small-note">분양 계약 체결 시 현금으로 납부하는 금액입니다.</p>
                    
                    <h4>2단계: 중도금 납부 (60%)</h4>
                    <div class="item"><strong>총 중도금</strong> <span class="amount">${midTotal.toFixed(1)}억</span></div>
                    <div class="item sub-item">
                        <!-- 파란색 수정 -->
                        └ 집단 대출 (${(midRate).toFixed(0)}%) <span class="loan-bg amount mid-loan-amount">${midLoanPossible.toFixed(1)}억</span>
                    </div>
                    <div class="item sub-item" style="border-bottom:none;">
                        <strong>└ 자납 중도금 (${((1 - midRate/100) * 100).toFixed(0)}%)</strong> 
                        <span class="big-amount" style="color: #d9480f;">${midSelf.toFixed(2)}억</span>
                    </div>
                    <p class="small-note">입주 전까지 대출 이자만 납부하며, 자납분은 현금으로 지출됩니다.</p>
                    
                    <h4>3단계: 잔금 대출 실행 및 최종 정산 (입주 시점)</h4>
                    <div class="item loan-flow-item"><strong>총 잔금액 (30%)</strong> <span class="amount">${balance.toFixed(2)}억</span></div>
                    <div class="item loan-flow-item"><strong>최대 잔금 대출 실행금</strong> <span class="loan-bg amount" style="color:#007bff !important;">${finalLoan.toFixed(2)}억</span></div>
                    <div class="item loan-flow-item" style="border-top: 1px dashed #ced4da;">
                        <strong>잔금 현금 필요액 (잔금 - 대출)</strong> 
                        <!-- 잔금에서 최대 잔금 대출을 단순 차감하여 현금 필요액 계산 -->
                        <span class="big-amount" style="color:#d9480f;">${Math.max(0, balance - finalLoan).toFixed(2)}억</span>
                    </div>
                    
                    <div style="margin-top: 10px; padding: 10px; background: #fff;">
                        <p class="small-note" style="text-align: left; font-weight: 600; margin-top: 0;">
                            * 잔금 납부 시 현금으로 총 
                            <span class="convertible" style="color:#dc3545;">${(midLoanNotFullyCovered + balanceCashReq).toFixed(2)}억</span>이 지출됩니다.
                        </p>
                        <p class="small-note" style="text-align: left;">
                            (잔금 대출 한도 초과분 + 중도금 대환 부족분)
                        </p>
                    </div>

                    <h4>4단계: 부대비용 납부 (취득세 3.3% 기준)</h4>
                    <div class="item loan-flow-item">
                        <strong>총 부대비용 지출액</strong> 
                        <span class="big-amount" style="color:#d9480f;">${totalCost.toFixed(2)}억</span>
                    </div>
                    <div class="item sub-item">└ 취득세 (3.3%) <span class="amount">${tax.toFixed(2)}억</span></div>
                    <div class="item sub-item">└ 중개 보수료 (0.6%) <span class="amount">${brokerage.toFixed(2)}억</span></div>
                    <div class="item sub-item" style="border-bottom:none;">└ 기타 비용 <span class="amount">${etc.toFixed(1)}억</span></div>
                    <p class="small-note">부대비용은 현금으로 납부해야 하는 지출액입니다.</p>

                    <h4>5단계: 총 현금 지출 발생액 (최종 현금 필요액)</h4>
                    <div class="item" style="border-top: 3px double #dc3545; margin-top: 15px; padding: 15px 0;">
                        <strong>총 현금 지출 발생액 (최종 현금 필요액)</strong> 
                        <span class="convertible big-amount" style="font-size: 1.6rem; color: #dc3545;">${finalCashOutlay.toFixed(2)}억</span>
                    </div>
                    <p class="small-note">
                        (구성: 1단계 계약금 + 2단계 자납 중도금 + 3단계 현금 납부액 + 4단계 부대비용)
                    </p>
                `;

                document.getElementById('loan-flow-section').style.display = 'block';
                document.getElementById('loan-flow-content').innerHTML = loanFlowHtml;
            }
            
            // 총 자금 (Total Funding) 계산
            const totalFunding = assets + finalLoan;

            // 현금 잔여/부족분 계산
            const remain = totalFunding - (price + totalCost);
            
            const ok = remain >= 0;
            
            document.getElementById('total-summary').innerHTML = `
                <div class="item"><strong>A. 총 비용<br>(주택가 + 부대비용)</strong> <span class="big-amount total-outlay">${(price + totalCost).toFixed(2)}억</span></div>
                <div class="item"><strong>B. 확보된 자금<br>(자산 + 잔금대출)</strong> <span class="big-amount total-outlay" style="color:#007bff;">${totalFunding.toFixed(2)}억</span></div>
                <div class="item sub-item" style="border-bottom: none;">└ 보유 자산 (현금) <span class="amount">${assets.toFixed(1)}억</span></div>
                <div class="item sub-item">└ 최대 잔금 대출금 <span class="loan-bg amount">${finalLoan.toFixed(1)}억</span></div>
                <div class="item" style="border-top:3px double #ced4da;">
                    <strong>C. 최종 잔여 현금 (B - A)</strong> 
                    <span class="highlight">${remain.toFixed(2)}억</span>
                </div>
            `;

            const remainText = remain >= 0 ? `${remain.toFixed(2)}억 여유` : `${Math.abs(remain).toFixed(2)}억 부족`;
            document.getElementById('feasibility').innerHTML = `<span class="${ok ? 'possible' : 'impossible'}">${ok ? '자금 조달 가능' : '자금 조달 부족'} (${remainText})</span>`;
            
            const P = finalLoan * 100000000;
            const r = rate / 100 / 12;
            const n = reg.term * 12;
            const level = r > 0 ? P * r * Math.pow(1 + r, n) / (Math.pow(1 + r, n) - 1) : P / n;
            const principalMonthly = P / n;
            const interestFirst = P * r;
            const interestLast = principalMonthly * r;
            const avgEqual = principalMonthly + (interestFirst + interestLast) / 2;
            
            document.getElementById('monthly-equal-principal').innerHTML = `${Math.round(avgEqual / 10000).toLocaleString()}만원`;
            document.getElementById('monthly-level-payment').innerHTML = `${Math.round(level / 10000).toLocaleString()}만원`;
            document.getElementById('total-loan-display').innerHTML = finalLoan.toFixed(1);
            
            document.getElementById('result').style.display = 'block';
            window.scrollTo({ top: document.getElementById('result').offsetTop - 20, behavior: 'smooth' });
        }
        updateRules();
        toggleMidLoan();
    </script>
</body>
</html>
