<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 부동산 투자 시뮬레이터 (모바일 최적화)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 커스텀 스타일: Inter 폰트, 기본 스타일 초기화 */
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f4f6f8; }
        /* 입력 필드 및 버튼에 그림자 및 라운딩 추가 */
        .input-group, button { transition: all 0.2s; }
        .input-group:focus-within { box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); }
        /* 결과 박스 애니메이션 */
        #result { opacity: 0; transform: translateY(20px); transition: opacity 0.5s ease-out, transform 0.5s ease-out; }
        .result-visible { opacity: 1 !important; transform: translateY(0) !important; }
        /* 모바일 최적화를 위한 버튼 폰트 크기 조정 */
        button { font-size: 1.125rem; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#3b82f6', /* Blue 500 */
                        'secondary': '#10b981', /* Emerald 500 (Success) */
                        'warning': '#f97316', /* Orange 600 (Lack) */
                        'bg-light': '#f4f6f8',
                        'card-bg': '#ffffff',
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 sm:p-6 max-w-xl mx-auto">

    <!-- Header & Description -->
    <header class="text-center mb-6">
        <h1 class="text-2xl font-extrabold text-gray-800">2025 부동산 투자 시뮬레이터</h1>
        <p class="text-sm text-gray-500 mt-1">2025.10.15 규제 (금융위원회 FAQ 기준)</p>
    </header>

    <form id="simulatorForm" class="bg-card-bg p-6 rounded-xl shadow-lg">

        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">기본 정보 입력</h2>

        <!-- Input Group: 주택 유형 -->
        <div class="mb-4">
            <label for="type" class="block text-sm font-semibold text-gray-700 mb-1">주택 유형</label>
            <select id="type" onchange="toggleMidLoan(); updateRules();" class="input-group w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                <option value="buy">일반 매매</option>
                <option value="lottery">청약/분양</option>
            </select>
        </div>

        <!-- Input Group: 주택 가격 -->
        <div class="mb-4">
            <label for="price" class="block text-sm font-semibold text-gray-700 mb-1">주택 가격 (억 원)</label>
            <input type="number" id="price" placeholder="10" step="0.1" oninput="updateRules(); showCap();" class="input-group w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
        </div>

        <!-- Input Group: 투자 지역 -->
        <div class="mb-4">
            <label for="region" class="block text-sm font-semibold text-gray-700 mb-1">투자 지역</label>
            <select id="region" onchange="updateRules();" class="input-group w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                <option value="regulated">규제지역 (수도권 등)</option>
                <option value="non">비규제지역</option>
            </select>
        </div>

        <!-- Input Group: 보유 주택 수 -->
        <div class="mb-4">
            <label for="houses" class="block text-sm font-semibold text-gray-700 mb-1">보유 주택 수</label>
            <select id="houses" onchange="updateRules();" class="input-group w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                <option value="0">무주택</option>
                <option value="1">1주택</option>
                <option value="multi">다주택</option>
            </select>
        </div>

        <!-- LTV/Cap Display -->
        <div class="bg-blue-50 border-l-4 border-primary p-3 rounded-md mb-4 text-center">
            <div class="text-sm font-semibold text-blue-700" id="ltv-display">LTV: 계산 중...</div>
            <div class="text-sm font-semibold text-red-600 hidden mt-1" id="cap-display">고가한도: 적용 중...</div>
        </div>

        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 mt-6">자금/소득 정보</h2>

        <!-- Input Group: 보유 자산 -->
        <div class="mb-4">
            <label for="assets" class="block text-sm font-semibold text-gray-700 mb-1">보유 자산 (억 원)</label>
            <input type="number" id="assets" placeholder="3" step="0.1" class="input-group w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
        </div>

        <!-- Input Group: 연간 소득 -->
        <div class="mb-4">
            <label for="income" class="block text-sm font-semibold text-gray-700 mb-1">연간 소득 (세전, 억 원)</label>
            <input type="number" id="income" placeholder="1" step="0.1" class="input-group w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
        </div>

        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 mt-6">대출 조건</h2>

        <!-- Input Group: 청약 중도금 대출 비율 (숨김/표시 토글) -->
        <div class="mid-loan mb-4 hidden">
            <label for="midLoanRate" class="block text-sm font-semibold text-gray-700 mb-1">건설사 중도금 대출 비율 (%)</label>
            <input type="number" id="midLoanRate" placeholder="40" step="5" min="0" max="60" class="input-group w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
        </div>
        
        <!-- Input Group: 대출 금리 -->
        <div class="mb-6">
            <label for="interestRate" class="block text-sm font-semibold text-gray-700 mb-1">대출 금리 (%)</label>
            <input type="number" id="interestRate" placeholder="4.0" step="0.1" class="input-group w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
        </div>

        <button type="button" onclick="calculate()" class="w-full bg-primary hover:bg-blue-600 text-white font-bold py-3 rounded-xl shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-blue-300">
            결과 분석하기
        </button>
    </form>

    <!-- Result Section -->
    <div id="result" class="mt-8 bg-card-bg p-6 rounded-xl shadow-lg">
        <h2 class="text-2xl font-extrabold text-gray-800 text-center mb-6">투자 분석 결과</h2>

        <!-- Section 3: 총 정리 (최상단으로 이동) -->
        <div class="section mb-6 p-4 rounded-xl border-4" id="section-summary">
            <h3 class="text-xl font-bold text-gray-800 mb-4">1. 최종 자금 조달 요약</h3>
            <div id="total-summary" class="space-y-3"></div>
            <div id="feasibility" class="mt-5 p-4 rounded-lg text-center font-extrabold text-xl shadow-inner"></div>
        </div>
        
        <!-- Section 1: 대출 한도 -->
        <div class="section bg-gray-50 p-4 rounded-xl shadow-sm mb-6" id="section-loan-limit">
            <h3 class="text-xl font-bold text-gray-700 mb-4 border-b border-gray-200 pb-2">2. 최대 대출금</h3>
            <div id="final-loan-detail" class="text-center"></div>
            <div id="loan-breakdown" class="mt-4 border-t pt-3"></div>
        </div>

        <!-- Section 2: 현금 필요액 (매매 전용) -->
        <div class="section bg-gray-50 p-4 rounded-xl shadow-sm mb-6" id="section-outlay">
            <h3 id="outlay-title" class="text-xl font-bold text-gray-700 mb-4 border-b border-gray-200 pb-2">3. 매매 개요 및 총 현금 필요액</h3>
            <div id="outlay-items" class="space-y-2"></div>
            <p class="text-xs text-gray-500 mt-4">취득세 3.3% + 중개 보수료 0.6% + 기타 0.1억 적용</p>
        </div>

        <!-- Section 2: 현금 흐름 (청약 전용) -->
        <div class="section bg-gray-50 p-4 rounded-xl shadow-sm mb-6 hidden" id="loan-flow-section">
            <h3 class="text-xl font-bold text-gray-700 mb-4 border-b border-gray-200 pb-2">3. 현금 흐름 상세 분석</h3>
            <div id="loan-flow-content"></div>
        </div>

        <!-- Interest Section -->
        <div id="interest-section" class="bg-card-bg p-4 rounded-xl shadow-md border border-gray-200">
            <h3 class="text-xl font-bold text-gray-800 text-center mb-4"><span id="total-loan-display"></span>억 대출 월 상환 (30년)</h3>
            <div class="flex flex-col sm:flex-row gap-4">
                <div class="repay-card flex-1 p-4 rounded-xl bg-blue-50 border-2 border-primary text-center">
                    <h4 class="text-base font-semibold text-primary">원금 균등 (추천)</h4>
                    <div class="monthly text-2xl font-extrabold text-primary mt-1" id="monthly-equal-principal"></div>
                    <small class="block text-gray-500 text-sm mt-1">총이자 부담 최소</small>
                </div>
                <div class="repay-card flex-1 p-4 rounded-xl bg-white border border-gray-300 text-center">
                    <h4 class="text-base font-semibold text-gray-600">원리금 균등</h4>
                    <div class="monthly text-2xl font-extrabold text-gray-700 mt-1" id="monthly-level-payment"></div>
                    <small class="block text-gray-500 text-sm mt-1">매월 상환액 동일</small>
                </div>
            </div>
        </div>

        <!-- Policy Note -->
        <div class="tip-box mt-6 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded-r-md text-sm text-gray-700 leading-relaxed">
            <strong class="text-yellow-700">정책 참고 사항</strong>
            <br>
            • 규제지역 LTV 40% (다주택 0%, 중도금/이주비 제외)<br>
            • 수도권·규제지역 고가한도: 15억이하 6억, 15-25억 4억, 25억초과 2억<br>
            <a href="https://www.fsc.go.kr/po020201/85518?srchCtgry=&curPage=&srchKey=&srchText=&srchBeginDt=&srchEndDt=" target="_blank" class="inline-block mt-2 px-3 py-1 bg-yellow-600 text-white font-semibold text-xs rounded-lg hover:bg-yellow-700">[주요 정책 보기]</a>
        </div>
    </div>

    <script>
        // 전역 상수 및 초기화 (기존 로직 유지)
        const reg = {
            dsrRate: 0.4,
            stressRateReg: 0.03,
            stressRateNon: 0,
            costs: {
                taxRate: 0.033, // 취득세
                brokerageRate: 0.006, // 중개 보수료
                etc: 0.1 // 기타 비용 (억 원)
            },
            defaultRate: 4.0,
            term: 30
        };
        let currentLTV = 0;
        let currentLTVRate = '';
        let priceCap = 999;
        let isRegulatedCap = false;

        // 헬퍼 함수: 금액 포맷팅 (억 원)
        function formatAmount(amount, decimals = 2) {
            return parseFloat(amount).toFixed(decimals) + '억';
        }

        // 헬퍼 함수: 만 원 포맷팅 (월 상환액)
        function formatMonthly(amount) {
            return Math.round(amount / 10000).toLocaleString() + '만원';
        }

        // 중도금 대출 섹션 토글
        function toggleMidLoan() {
            const isLottery = document.getElementById('type').value === 'lottery';
            document.querySelector('.mid-loan').classList.toggle('hidden', !isLottery);
            updateRules();
        }

        // 고가한도 표시
        function showCap() {
            const price = parseFloat(document.getElementById('price').value) || 0;
            const region = document.getElementById('region').value;
            const capDisplay = document.getElementById('cap-display');

            if (region === 'regulated') {
                let cap = price > 25 ? 2 : (price > 15 ? 4 : (price > 9 ? 6 : 999)); // 9억 초과 시 고가한도 적용 가정
                if (price > 9) {
                     capDisplay.innerHTML = `고가한도 적용: 최대 ${cap}억`;
                     capDisplay.classList.remove('hidden');
                } else {
                    capDisplay.classList.add('hidden');
                }
            } else {
                capDisplay.classList.add('hidden');
            }
        }

        // LTV/DTI/DSR 규제 로직 업데이트
        function updateRules() {
            const region = document.getElementById('region').value;
            const houses = document.getElementById('houses').value;
            const special = 'no'; // '서민·실수요자' 옵션 삭제됨
            const price = parseFloat(document.getElementById('price').value) || 0;
            const type = document.getElementById('type').value;

            if (houses === 'multi') {
                currentLTV = 0;
                currentLTVRate = '다주택 0%';
                document.getElementById('ltv-display').innerHTML = '<span class="text-red-600 font-extrabold">다주택: LTV 0% (대출 불가)</span>';
                document.getElementById('cap-display').classList.add('hidden');
                return;
            }

            // 기본 LTV 설정
            let base = region === 'regulated' ? 0.4 : 0.7;
            let rateStr = region === 'regulated' ? '40%' : '70%';

            currentLTV = base;
            currentLTVRate = rateStr;
            const ltvAmt = price * currentLTV;

            document.getElementById('ltv-display').innerHTML = `LTV ${rateStr} → 최대 <span class="text-primary">${ltvAmt.toFixed(1)}억</span>`;
            isRegulatedCap = (region === 'regulated' && price > 9); // 고가한도는 규제지역 & 9억 초과 시 적용

            if (isRegulatedCap) {
                priceCap = price > 25 ? 2 : (price > 15 ? 4 : 6);
                showCap();
            } else {
                priceCap = 999;
                document.getElementById('cap-display').classList.add('hidden');
            }
            
            // 섹션 가시성 관리
            const isLottery = type === 'lottery';
            document.getElementById('section-outlay').classList.toggle('hidden', isLottery);
            document.getElementById('loan-flow-section').classList.toggle('hidden', !isLottery);
            
            // 섹션 제목 업데이트 (순서 변경에 따라)
            document.getElementById('section-loan-limit').querySelector('h3').textContent = '2. 최대 대출금'; // 타이틀 변경
            if (!isLottery) {
                document.getElementById('outlay-title').textContent = '3. 매매 개요 및 총 현금 필요액';
            } else {
                document.getElementById('loan-flow-section').querySelector('h3').textContent = '3. 현금 흐름 상세 분석';
            }
        }

        // DSR 기반 최대 대출 원금 계산
        function calculateDSRMaxPrincipal(annualIncome, annualRate, stress) {
            if (annualIncome <= 0) return 0;
            const stressAdj = (annualRate / 100) + stress;
            const monthlyIncome = annualIncome * 100000000 / 12;
            const monthlyRate = stressAdj / 12;
            const months = reg.term * 12;
            const dsrMonthly = monthlyIncome * reg.dsrRate;
            
            if (monthlyRate <= 0) {
                 // 이자가 0인 경우 (단순 원금 균등 상환으로 가정)
                return (dsrMonthly * months) / 100000000; 
            }
            
            const pow = Math.pow(1 + monthlyRate, months);
            // 원리금 균등 상환 방식 기준 최대 대출 원금 공식
            const maxP = dsrMonthly * (pow - 1) / (monthlyRate * pow);
            return maxP / 100000000; // 억 원
        }

        // 메인 계산 함수
        function calculate() {
            const type = document.getElementById('type').value;
            const price = parseFloat(document.getElementById('price').value) || 0;
            const assets = parseFloat(document.getElementById('assets').value) || 0;
            const income = parseFloat(document.getElementById('income').value) || 0;
            const rate = parseFloat(document.getElementById('interestRate').value) || reg.defaultRate;
            const region = document.getElementById('region').value;
            const midRate = type === 'lottery' ? parseFloat(document.getElementById('midLoanRate').value) || 40 : 0;
            
            if (price <= 0 || income <= 0 || (type === 'lottery' && price < 1)) {
                 document.getElementById('result').classList.remove('result-visible');
                 alert('주택 가격과 연간 소득을 정확히 입력해 주세요.');
                 return;
            }
            
            // 1. 최대 잔금 대출금 (LTV/DSR/Cap 중 최소값) 계산
            const ltvAmt = price * currentLTV;
            const stress = (region === 'regulated') ? reg.stressRateReg : reg.stressRateNon;
            const dsrAmt = calculateDSRMaxPrincipal(income, rate, stress);
            let finalLoan = Math.min(ltvAmt, dsrAmt);
            if (isRegulatedCap) finalLoan = Math.min(finalLoan, priceCap);
            
            let minSource = finalLoan === ltvAmt ? `LTV (${currentLTVRate})` : finalLoan === dsrAmt ? 'DSR (40%+스트레스)' : '고가한도';
            
            // 2. 비용 계산
            const tax = price * reg.costs.taxRate;
            const brokerage = reg.costs.brokerageRate;
            const etc = reg.costs.etc;
            let totalCost;

            if (type === 'buy') {
                // 일반 매매: 기존 비용 모두 포함
                totalCost = tax + (price * brokerage) + etc;
                document.getElementById('section-outlay').querySelector('p').innerHTML = '취득세 3.3% + 중개 보수료 0.6% + 기타 0.1억 적용';

            } else {
                // 청약/분양: 취득세(3.3%)만 포함 요청 반영
                totalCost = tax;
            }


            // --- Section 2: 대출 한도 및 최대 대출금 (순서 2) ---
            let loanDetailHtml = '';
            let loanBreakdownHtml = '';
            
            const midLoanPossible = type === 'lottery' ? price * (midRate / 100) : 0; // 중도금 실행 가능액

            if (type === 'lottery') {
                loanDetailHtml += `
                    <div class="p-3 bg-red-50 border border-red-300 rounded-lg mb-4">
                        <p class="text-sm font-semibold text-red-600 mb-1">중도금 대출 (집단 대출)</p>
                        <span class="text-2xl font-extrabold text-red-700">${formatAmount(midLoanPossible, 1)}</span>
                        <!-- [MODIFIED] 문구 수정 및 강조 -->
                        <p class="text-xs text-gray-500 mt-1">(${midRate}% 실행 기준, <strong class="text-red-700">입주 시 반드시 정산 필요</strong>)</p>
                    </div>
                `;
            }

            loanDetailHtml += `
                <div class="p-3 bg-blue-50 border border-primary rounded-lg mb-4">
                    <p class="text-sm font-semibold text-primary mb-1">최대 실행 대출금</p>
                    <span class="text-3xl font-extrabold text-primary">${formatAmount(finalLoan, 1)}</span>
                    <p class="text-xs text-gray-500 mt-1">(${minSource} 기준)</p>
                </div>
            `;
            
            loanBreakdownHtml = `<div class="space-y-2 text-sm">
                <div class="flex justify-between items-center text-gray-700"><strong>LTV (${currentLTVRate})</strong> <span class="font-semibold text-gray-800">${formatAmount(ltvAmt, 1)}</span></div>
                <div class="flex justify-between items-center text-gray-700"><strong>DSR (40%+스트레스)</strong> <span class="font-semibold text-gray-800">${formatAmount(dsrAmt, 1)}</span></div>`;
            if (isRegulatedCap) {
                 loanBreakdownHtml += `<div class="flex justify-between items-center text-gray-700"><strong>고가한도</strong> <span class="font-semibold text-gray-800">${formatAmount(priceCap, 0)}</span></div>`;
                 // 고가한도 상세 내용 추가
                 loanBreakdownHtml += `
                    <div class="mt-2 p-2 bg-gray-100 rounded text-xs text-gray-600">
                        <p><strong>주택가격별 최대 한도:</strong></p>
                        <ul class="list-disc ml-4">
                            <li>15억 이하: 6억</li>
                            <li>15억 초과 ~ 25억 이하: 4억</li>
                            <li>25억 초과: 2억</li>
                        </ul>
                    </div>
                `;
            }
            loanBreakdownHtml += '</div>';

            document.getElementById('final-loan-detail').innerHTML = loanDetailHtml;
            document.getElementById('loan-breakdown').innerHTML = loanBreakdownHtml;


            // --- Section 3 Content Generation: 현금 필요액 ---
            let finalCashOutlay = 0;

            if (type === 'buy') {
                // 일반 매매 (기존 로직 유지)
                const cashOutlay = price - finalLoan + totalCost;
                finalCashOutlay = cashOutlay;
                
                outlayHtml = `
                    <div class="flex justify-between items-center text-lg font-bold text-gray-800 border-b pb-2 mb-2">
                        <span>주택가격</span> <span class="text-primary">${formatAmount(price, 1)}</span>
                    </div>
                    <div class="flex justify-between items-center text-sm text-gray-700">
                        <span>대출 제외 잔금 (현금)</span> <span class="font-semibold">${formatAmount(price - finalLoan, 2)}</span>
                    </div>
                    <div class="flex justify-between items-center text-sm text-gray-700">
                        <span>취득세 (3.3%)</span> <span class="font-semibold">${formatAmount(tax, 2)}</span>
                    </div>
                    <div class="flex justify-between items-center text-sm text-gray-700">
                        <span>중개 보수료 (${(brokerage * 100).toFixed(1)}%)</span> <span class="font-semibold">${formatAmount(price * brokerage, 2)}</span>
                    </div>
                    <div class="flex justify-between items-center text-sm text-gray-700 border-b border-dashed pb-3">
                        <span>기타 비용</span> <span class="font-semibold">${formatAmount(etc, 1)}</span>
                    </div>
                    <div class="flex justify-between items-center text-2xl font-extrabold mt-3 pt-2">
                        <span>총 현금 지출 발생액</span> 
                        <span class="text-warning">${formatAmount(finalCashOutlay, 2)}</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 text-right">(총 현금 필요액 = 주택가격 + 부대비용 - 최대 잔금 대출금)</p>
                `;
                document.getElementById('outlay-items').innerHTML = outlayHtml;
                
            } else {
                // 청약/분양 (요청에 따라 대폭 수정)
                const contract = price * 0.1;
                const midTotal = price * 0.6;
                const midSelf = midTotal - midLoanPossible;
                const balance = price * 0.3;
                
                // 잔금 납부에 필요한 현금액 (최대 대출 한도를 초과하는 잔금분)
                const cashPaymentForBalance = Math.max(0, balance - finalLoan); 
                
                // 총 현금 지출 발생액 = 계약금 + 자납 중도금 + 잔금 현금 납부액 + 총 부대비용(취득세)
                finalCashOutlay = contract + midSelf + cashPaymentForBalance + totalCost;

                // [MODIFIED] 총 대출금 계산
                const totalLoanGenerated = midLoanPossible + finalLoan;

                const loanFlowHtml = `
                    <!-- 1단계: 계약금 (10%) -->
                    <div class="p-3 mb-4 bg-white rounded-lg shadow-sm border border-gray-200">
                        <h4 class="text-base font-bold text-gray-800 flex justify-between items-center">
                            <span>1단계: 계약금 (10%)</span> 
                            <span class="text-gray-800 font-bold">${formatAmount(contract, 2)}</span> 
                        </h4>
                        <div class="text-sm font-normal">
                            <div class="flex justify-between text-gray-700">
                                <span>현금 지출액</span> 
                                <span class="text-warning font-extrabold">${formatAmount(contract, 2)}</span> 
                            </div>
                        </div>
                    </div>
                    
                    <!-- 2단계: 중도금 (60%) -->
                    <div class="p-3 mb-4 bg-white rounded-lg shadow-sm border border-gray-200">
                        <h4 class="text-base font-bold text-gray-800 flex justify-between items-center">
                            <span>2단계: 중도금 (60%)</span> 
                            <span class="text-gray-800 font-bold">${formatAmount(midTotal, 2)}</span>
                        </h4>
                        <div class="text-sm">
                            <div class="flex justify-between text-gray-700">
                                <span>집단 대출 (${midRate}%)</span> 
                                <span class="text-primary font-extrabold">${formatAmount(midLoanPossible, 1)}</span> 
                            </div>
                            <!-- [MODIFIED] 점선 구분선 추가 -->
                            <div class="flex justify-between mt-1 pt-1 border-t border-dashed text-gray-800">
                                <span>자납 중도금 (${((1 - midRate/100) * 100).toFixed(0)}%)</span> 
                                <span class="text-warning font-extrabold">${formatAmount(midSelf, 2)}</span> 
                            </div>
                        </div>
                    </div>

                    <!-- 3단계: 잔금 (30%) -->
                    <div class="p-3 mb-4 bg-white rounded-lg shadow-sm border border-gray-200">
                        <h4 class="text-base font-bold text-gray-800 flex justify-between items-center">
                            <span>3단계: 잔금 (30%)</span> 
                            <span class="text-gray-800 font-bold">${formatAmount(balance, 2)}</span>
                        </h4>
                        <div class="text-sm">
                            <div class="flex justify-between text-gray-700">
                                <span>총 잔금액 (30%)</span> 
                                <span class="font-normal">${formatAmount(balance, 2)}</span>
                            </div>
                            <!-- [MODIFIED] 파란색 볼드체 적용 -->
                            <div class="flex justify-between text-gray-700">
                                <span>최대 잔금 대출 실행금</span> 
                                <span class="text-primary font-extrabold">${formatAmount(finalLoan, 2)}</span> 
                            </div>
                            <div class="flex justify-between mt-1 text-gray-800 border-t border-dashed pt-2">
                                <span>잔금 현금 납부액</span> 
                                <span class="text-warning font-extrabold">${formatAmount(cashPaymentForBalance, 2)}</span> 
                            </div>
                        </div>
                    </div>
                    
                    <!-- 4단계: 부대비용 (Modified: Only Tax remains) -->
                    <div class="p-3 mb-4 bg-white rounded-lg shadow-sm border border-gray-200">
                        <h4 class="text-base font-bold text-gray-800 flex justify-between items-center">
                            <span>4단계: 부대비용</span> 
                            <span class="text-gray-800 font-bold">${formatAmount(totalCost, 2)}</span>
                        </h4>
                        <div class="text-sm">
                            <div class="flex justify-between text-gray-700">
                                <span>취득세 (3.3%)</span> 
                                <span class="text-warning font-extrabold">${formatAmount(tax, 2)}</span> 
                            </div>
                        </div>
                    </div>

                    <!-- 총 현금 흐름 (New Summary) -->
                    <h3 class="text-2xl font-extrabold text-gray-800 mt-6 pt-2 border-t-2 border-dashed border-gray-300 text-center">총 현금 흐름</h3>

                    <div class="space-y-4 mt-4">
                        <!-- 대출금 서브 타이틀 -->
                        <div class="p-3 bg-blue-50/70 rounded-lg">
                            <h4 class="text-lg font-bold text-primary mb-2">대출금</h4>
                            <div class="flex justify-between text-base text-gray-700">
                                <span>중도금 집단대출</span> 
                                <span class="font-extrabold text-primary">${formatAmount(midLoanPossible, 2)}</span>
                            </div>
                            <div class="flex justify-between text-base text-gray-700 mt-1">
                                <span>잔금 대출</span> 
                                <span class="font-extrabold text-primary">${formatAmount(finalLoan, 2)}</span>
                            </div>
                            <!-- [MODIFIED] 총 대출금 발생액 추가 -->
                            <div class="flex justify-between items-center text-lg font-extrabold text-primary mt-2 pt-2 border-t-2 border-dashed border-blue-200">
                                <span>총 대출금 발생액</span>
                                <span>${formatAmount(totalLoanGenerated, 2)}</span>
                            </div>
                        </div>
                        <!-- [MODIFIED] 경고 문구 추가 -->
                        <p class="text-sm font-extrabold text-red-600 text-center -mt-2">
                            **중도금 집단 대출금은 입주 때 잔금과 상환 필수**
                        </p>

                        <!-- 현금 지출 서브 타이틀 -->
                        <div class="p-3 bg-red-50/70 rounded-lg">
                            <h4 class="text-lg font-bold text-warning mb-2">현금 지출</h4>
                            <div class="flex justify-between text-base text-gray-700">
                                <span>계약금</span> 
                                <span class="font-extrabold text-warning">${formatAmount(contract, 2)}</span>
                            </div>
                            <div class="flex justify-between text-base text-gray-700 mt-1">
                                <span>자납 중도금</span> 
                                <span class="font-extrabold text-warning">${formatAmount(midSelf, 2)}</span>
                            </div>
                            <div class="flex justify-between text-base text-gray-700 mt-1">
                                <span>잔금 부족금</span> 
                                <span class="font-extrabold text-warning">${formatAmount(cashPaymentForBalance, 2)}</span>
                            </div>
                            <div class="flex justify-between text-base text-gray-700 mt-1">
                                <span>부대비용 (취득세)</span> 
                                <span class="font-extrabold text-warning">${formatAmount(totalCost, 2)}</span>
                            </div>
                        </div>
                        <!-- [MODIFIED] '총 현금 지출 발생액' 레이블도 주황색으로 변경 -->
                        <div class="flex justify-between items-center text-xl font-extrabold mt-4 pt-2 border-t-2 border-dashed border-gray-300">
                            <span class="text-warning">총 현금 지출 발생액</span> 
                            <span class="text-warning">${formatAmount(finalCashOutlay, 2)}</span>
                        </div>
                    </div>
                `;
                document.getElementById('loan-flow-content').innerHTML = loanFlowHtml;
            }

            // --- Section 1 Content Generation: 총 정리 (순서 1) ---
            const totalCostFinal = price + totalCost;
            
            // [MODIFIED] B항목 합산 로직 변경 (사용자 요청 반영)
            let totalFunding;
            if (type === 'lottery') {
                totalFunding = assets + midLoanPossible + finalLoan; 
            } else {
                totalFunding = assets + finalLoan;
            }
            
            const remain = totalFunding - totalCostFinal;
            const ok = remain >= 0;

            // [MODIFIED] B항목 타이틀 및 중도금 대출 항목 추가
            const summaryHtml = `
                <div class="flex justify-between items-center text-base font-semibold text-gray-700">
                    <span>A. 총 비용 (주택가 + 부대비용)</span> <span class="text-red-600">${formatAmount(totalCostFinal, 2)}</span>
                </div>
                <!-- [MODIFIED] B 항목 타이틀 변경 -->
                <div class="flex justify-between items-center text-base font-semibold text-gray-700">
                    <span>B. 확보된 자산/부채 (자산+대출)</span> <span class="text-primary">${formatAmount(totalFunding, 2)}</span>
                </div>
                <div class="pl-4 text-xs text-gray-500 flex justify-between">
                    <span>└ 보유 자산 (현금)</span> <span>${formatAmount(assets, 1)}</span>
                </div>
                <!-- [MODIFIED] B 항목 중도금 대출 라인 추가 -->
                ${type === 'lottery' ? `
                    <div class="pl-4 text-xs text-gray-500 flex justify-between">
                        <span>└ 중도금 집단 대출금</span> <span>${formatAmount(midLoanPossible, 1)}</span>
                    </div>
                ` : ''}
                <div class="pl-4 text-xs text-gray-500 flex justify-between border-b pb-2">
                    <span>└ 최대 잔금 대출금</span> <span>${formatAmount(finalLoan, 1)}</span>
                </div>
                <div class="flex justify-between items-center text-xl font-extrabold mt-3 pt-2">
                    <span>C. 최종 잔여 현금 (B - A)</span> 
                    <span class="${ok ? 'text-secondary' : 'text-warning'}">${formatAmount(remain, 2)}</span>
                </div>
            `;
            document.getElementById('total-summary').innerHTML = summaryHtml;

            const remainText = remain >= 0 ? `${formatAmount(remain, 2)} 여유` : `${formatAmount(Math.abs(remain), 2)} 부족`;
            
            // [MODIFIED] Feasibility text based on type
            let feasibilityText;
            if (type === 'lottery') {
                feasibilityText = ok ? '✅ 청약 가능' : '❌ 청약 불가';
            } else {
                feasibilityText = ok ? '✅ 자금 조달 가능' : '❌ 자금 조달 부족';
            }

            const feasibilityClass = ok ? 'bg-secondary/10 text-secondary border-secondary' : 'bg-warning/10 text-warning border-warning';
            document.getElementById('feasibility').innerHTML = `
                <span class="text-xl">${feasibilityText}</span>
                <span class="block text-base font-normal mt-1">(${remainText})</span>
            `;
            document.getElementById('section-summary').className = `section mb-6 p-4 rounded-xl border-4 ${ok ? 'border-secondary' : 'border-warning'}`;
            
            // --- Interest Section 계산 및 표시 ---
            const P = finalLoan * 100000000;
            const r = rate / 100 / 12;
            const n = reg.term * 12;
            
            // 원리금 균등 상환액 (Level Payment)
            const level = r > 0 ? P * r * Math.pow(1 + r, n) / (Math.pow(1 + r, n) - 1) : P / n;
            
            // 원금 균등 상환액 (Principal Equal - 첫 달 기준)
            const principalMonthly = P / n;
            const interestFirst = P * r;
            const equalPrincipalFirst = principalMonthly + interestFirst;

            document.getElementById('monthly-equal-principal').innerHTML = formatMonthly(equalPrincipalFirst);
            document.getElementById('monthly-level-payment').innerHTML = formatMonthly(level);
            document.getElementById('total-loan-display').innerHTML = finalLoan.toFixed(1);
            
            // 결과 표시
            const resultDiv = document.getElementById('result');
            resultDiv.classList.add('result-visible');
            window.scrollTo({ top: resultDiv.offsetTop - 20, behavior: 'smooth' });
        }
        
        // 초기화
        window.onload = function() {
            updateRules();
            toggleMidLoan();
            showCap();
        }
    </script>
</body>
</html>
